<?xml version="1.0" encoding="utf-8"?>
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-12-20 Fri 21:54 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>projet</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="frederic boileau" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://gongzhitaao.org/orgcss/org.css"/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">projet</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc8edab8">1. intro</a>
<ul>
<li><a href="#org428766b">1.1. abstract</a></li>
<li><a href="#orgcab6b86">1.2. big picture</a>
<ul>
<li><a href="#orgf8dfe55">1.2.1. ideas</a></li>
<li><a href="#orge1c0e78">1.2.2. motivation</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgcb24f81">2. lit review</a>
<ul>
<li><a href="#org3c18e6e">2.1. abstracts</a></li>
<li><a href="#orgb15f30e">2.2. general considerations</a></li>
<li><a href="#org5d6b7a4">2.3. the mainstream/industry now</a>
<ul>
<li><a href="#orgaa493f4">2.3.1. tapenade</a></li>
<li><a href="#org1878b14">2.3.2. tensorflow</a></li>
</ul>
</li>
<li><a href="#orgb3c5989">2.4. functional programming approach</a></li>
<li><a href="#org3420ffb">2.5. bib</a></li>
</ul>
</li>
<li><a href="#org7870a57">3. code</a>
<ul>
<li><a href="#org08f86ea">3.1. structure of typer</a>
<ul>
<li><a href="#orgd4ddfaa">3.1.1. typer/</a>
<ul>
<li><a href="#org28f87b5">3.1.1.1. .git</a></li>
<li><a href="#org70ad23a">3.1.1.2. .gitignore</a></li>
<li><a href="#org33c8823">3.1.1.3. .travis.yml</a></li>
<li><a href="#org7d2945a">3.1.1.4. COPYING</a></li>
<li><a href="#org4690c1a">3.1.1.5. GNUmakefile</a></li>
<li><a href="#org8a76168">3.1.1.6. README.md</a></li>
<li><a href="#org9de9a00">3.1.1.7. btl/</a></li>
<li><a href="#org4317a64">3.1.1.8. doc/</a></li>
<li><a href="#orgb6a9c4b">3.1.1.9. emacs/</a></li>
<li><a href="#org3e53123">3.1.1.10. opam</a></li>
<li><a href="#org7d6f9b1">3.1.1.11. src/</a></li>
<li><a href="#orgaabfb1b">3.1.1.12. tests/</a></li>
</ul>
</li>
<li><a href="#org249da12">3.1.2. reverse engineering&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notmine">notmine</span></span></a>
<ul>
<li><a href="#org8997518">3.1.2.1. util</a></li>
<li><a href="#org9c08c8a">3.1.2.2. prelexer</a></li>
<li><a href="#orgf883efb">3.1.2.3. grammar</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0899fbe">4. even if not surrounded by spaces, such as &rsquo;(&rsquo;, &rsquo;)&rsquo;, and &rsquo;;&rsquo;.</a></li>
<li><a href="#org72662dd">5. It also indicates which chars are &ldquo;inner&rdquo; operators, i.e. those chars</a></li>
<li><a href="#orgfa96770">6. that make up the inner structure of structured identifiers such as</a></li>
<li><a href="#orgc37aa8d">7. foo.bar.baz.  *)</a>
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#orgca80a65">7.0.0.1. grammar generator (emacs)</a></li>
</ul>
</li>
<li><a href="#orgd8a4a96">7.0.1. end</a></li>
</ul>
</li>
<li><a href="#orgb9eea15">7.1. ocaml stuff</a>
<ul>
<li><a href="#org0f6d5b1">7.1.1. map.make</a></li>
<li><a href="#org36506c7">7.1.2. end</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgad840b8">8. scrapbook</a>
<ul>
<li><a href="#org37b93c9">8.1. typer and ocaml compilation</a></li>
<li><a href="#org2ca058c">8.2. inductive types and coq theory</a></li>
<li><a href="#org718e179">8.3. more generality: elliot&rsquo;s categorical approach</a></li>
<li><a href="#orgc8b21c5">8.4. category theory and type theory and constructive math</a></li>
<li><a href="#orgf0414d4">8.5. end</a></li>
</ul>
</li>
<li><a href="#org8721638">9. local setup</a>
<ul>
<li><a href="#orgee66697">9.1. submodules</a>
<ul>
<li><a href="#org42f0584">9.1.1. typer lang</a></li>
<li><a href="#orgd8f688c">9.1.2. org-fs-tree</a></li>
<li><a href="#orgd577a57">9.1.3. org-ref</a>
<ul>
<li><a href="#orgaec02a4">9.1.3.1. git</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgb034d80">9.2. emacs</a>
<ul>
<li><a href="#org0f226f4">9.2.1. <span class="todo idea">idea</span> find publishing function for ml files</a></li>
<li><a href="#org9f3c544">9.2.2. publishing</a></li>
<li><a href="#org07ac4a5">9.2.3. refs</a></li>
<li><a href="#org3d6900a">9.2.4. org ui</a>
<ul>
<li><a href="#org359ffd1">9.2.4.1. typer mode</a></li>
<li><a href="#orgea6be5e">9.2.4.2. org fs tree</a></li>
</ul>
</li>
<li><a href="#org3cb31de">9.2.5. youtube&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notmine">notmine</span></span></a></li>
</ul>
</li>
<li><a href="#org32435e2">9.3. music</a></li>
<li><a href="#org57b5776">9.4. end</a></li>
</ul>
</li>
</ul>
</div>
</div>


<div id="outline-container-orgc8edab8" class="outline-2">
<h2 id="orgc8edab8"><span class="section-number-2">1</span> intro</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org428766b" class="outline-3">
<h3 id="org428766b"><span class="section-number-3">1.1</span> abstract</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Peter Norvig quote
</p>
</div>
</div>


<div id="outline-container-orgcab6b86" class="outline-3">
<h3 id="orgcab6b86"><span class="section-number-3">1.2</span> big picture</h3>
<div class="outline-text-3" id="text-1-2">
<p>
We can delineate the main approaches to AD as follows:
</p>

<ul class="org-ul">
<li>traditional : source to source transformation of mostly high performance imperative code, focus on C and Fortran</li>

<li>dynamic source to source (s2s):
in some cases JIT compilation (flux in Julia targetting the LLVM) blurs the
line between compiled and interpreted differentiated code.</li>

<li>dynamic dual overload :
in a language with support for operator overloading such as cpp we can wrap
programs to be differentiated in a monoidal like class and overload the basic
arithmetic operators according to the algebra of differential forms (or dual
numbers for the most simple case). In any case the foundation is introducing a
nilpotent element, say \[\epsilon \] , with \[ \epsilon ^ {2} \triangleq 0 \]</li>

<li><p>
formal-functional (s2s):
differentiation can be integrated within a type system thus allowing
compilation to fast parralelizable code through enforcing invariants such as
purity. Moroever polymorphism can be leveraged for fast, provenly correct yet
flexible code.
</p>

<p>
We will focus on the latest
</p></li>
</ul>
</div>


<div id="outline-container-orgf8dfe55" class="outline-4">
<h4 id="orgf8dfe55"><span class="section-number-4">1.2.1</span> ideas</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li>keep syntax explicit at the beginning and solve verbosity with macros
in the first place. Features can be built in later for convenience if
we need to.</li>
<li>inductive types, Leibniz equality erasable argumnets</li>
<li>large inductive types?</li>
<li>implicit calculus of constructions</li>
</ul>
</div>
</div>

<div id="outline-container-orge1c0e78" class="outline-4">
<h4 id="orge1c0e78"><span class="section-number-4">1.2.2</span> motivation</h4>
<div class="outline-text-4" id="text-1-2-2">
<p>
Numerical programming is mostly linear programming
in the end, although it is even more obvious when
neural networks are used.
</p>


<div id="org1345375" class="figure">
<p><img src="file:///home/gaston/org/.attach/_20191219_064117machine_learning.png" alt="_20191219_064117machine_learning.png" />
</p>
</div>
</div>
</div>
</div>
</div>




<div id="outline-container-orgcb24f81" class="outline-2">
<h2 id="orgcb24f81"><span class="section-number-2">2</span> lit review</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org3c18e6e" class="outline-3">
<h3 id="org3c18e6e"><span class="section-number-3">2.1</span> abstracts</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><p>
Backpropagator <a class='org-ref-reference' href="#Pearlmutter_2008">Pearlmutter_2008</a>
</p>
<blockquote>
<p>
We show that reverse-mode AD (Automatic Differentiation)—a generalized gradient-calculation
operator—can be incorporated as a first-class function in an augmented lambda calculus, and
therefore into a functional-programming language. Closure is achieved, in that the new operator
can be applied to any expression in the augmented language, yielding an expression in that
language. This requires the resolution of two major technical issues: (a) how to transform nested
lambda expressions, including those with free-variable references, and (b) how to support self
application of the AD machinery. AD transformations preserve certain complexity properties,
among them that the reverse phase of the reverse-mode AD transformation of a function have
the same temporal complexity as the original untransformed function. First-class unrestricted
AD operators increase the expressive power available to the numeric programmer, and may have
significant practical implications for the construction of numeric software that is robust, modular,
concise, correct, and efficient.
</p>
</blockquote></li>
<li><p>
F smooth <a class='org-ref-reference' href="#array2019">array2019</a>
</p>
<blockquote>
<p>
We present a system for the automatic differentiation (AD) of a higher-order functional array-processing
language. The core functional language underlying this system simultaneously supports both source-to-
source forward-mode AD and global optimisations such as loop transformations. In combination, gradient
computation with forward-mode AD can be as efficient as reverse mode, and that the Jacobian matrices required
for numerical algorithms such as Gauss-Newton and Levenberg-Marquardt can be efficiently computed.
</p>
</blockquote></li>
<li><p>
Mya : <a class='org-ref-reference' href="#autoDiffInML2018">autoDiffInML2018</a>
</p>
<blockquote>
<p>
We review the current state of automatic differentiation (AD) for array program-
ming in machine learning (ML), including the different approaches such as operator
overloading (OO) and source transformation (ST) used for AD, graph-based in-
termediate representations for programs, and source languages. Based on these
insights, we introduce a new graph-based intermediate representation (IR) which
specifically aims to efficiently support fully-general AD for array programming.
Unlike existing dataflow programming representations in ML frameworks, our IR
naturally supports function calls, higher-order functions and recursion, making
ML models easier to implement. The ability to represent closures allows us to
perform AD using ST without a tape, making the resulting derivative (adjoint) pro-
gram amenable to ahead-of-time optimization using tools from functional language
compilers, and enabling higher-order derivatives. Lastly, we introduce a proof of
concept compiler toolchain called Myia which uses a subset of Python as a front
end.
</p>
</blockquote></li>
<li><p>
Zygote :  <a class='org-ref-reference' href="#innes2018dont">innes2018dont</a>
</p>
<blockquote>
<p>
This paper presents reverse-mode algorithmic differentiation (AD) based on source code transformation, in par-
ticular of the Static Single Assignment (SSA) form used by modern compilers. The approach can support control
flow, nesting, mutation, recursion, data structures, higher-order functions, and other language constructs, and the
output is given to an existing compiler to produce highly efficient differentiated code. Our implementation is a
new AD tool for the Julia language, called Zygote, which presents high-level dynamic semantics while transpar-
ently compiling adjoint code under the hood. We discuss the benefits of this approach to both the usability and
performance of AD tools.
</p>
</blockquote></li>
<li><p>
Elliot : <a class='org-ref-reference' href="#elliott18">elliott18</a>
</p>
<blockquote>
<p>
Automatic differentiation (AD) in reverse mode (RAD) is a central component of deep learning and
other uses of large-scale optimization. Commonly used RAD algorithms such as backpropagation, however,
are complex and stateful, hindering deep understanding, improvement, and parallel execution. This paper
develops a simple, generalized AD algorithm calculated from a simple, natural specification. The general
algorithm is then specialized by varying the representation of derivatives. In particular, applying well-known
constructions to a naive representation yields two RAD algorithms that are far simpler than previously known.
In contrast to commonly used RAD implementations, the algorithms defined here involve no graphs, tapes,
variables, partial derivatives, or mutation. They are inherently parallel-friendly, correct by construction, and
usable directly from an existing programming language with no need for new data types or programming
style, thanks to use of an AD-agnostic compiler plugin.
</p>
</blockquote></li>
<li><p>
categories : <a class='org-ref-reference' href="#elliott17_compil_to_categ">elliott17_compil_to_categ</a>
</p>
<blockquote>
<p>
It is well-known that the simply typed lambda-calculus is modeled by any cartesian closed category
(CCC). This correspondence suggests giving typed functional programs a variety of interpretations, each
corresponding to a different category. A convenient way to realize this idea is as a collection of meaning-
preserving transformations added to an existing compiler, such as GHC for Haskell. This paper describes
such an implementation and demonstrates its use for a variety of interpretations including hardware circuits,
automatic differentiation, incremental computation, and interval analysis. Each such interpretation is a
category easily defined in Haskell (outside of the compiler). The general technique appears to provide a
compelling alternative to deeply embedded domain-specific languages.
</p>
</blockquote></li>
<li><p>
tapenade : <a class='org-ref-reference' href="#Hascoet2013TTA">Hascoet2013TTA</a>
</p>
<blockquote>
<p>
Tapenade is an Automatic Differentiation tool which, given a Fortran or C code
that computes a function, creates a new code that computes its tangent or
adjoint derivatives. Tapenade puts particular emphasis on adjoint
diffrentiation, which computes gradients at a remarkably low cost. This paper
describes the principles of Tapenade, a subset of the general principles of
AD. We motivate and illustrate on examples the AD model of Tapenade, i.e. the
structure of differentiated codes and the strategies used to make them more
efficient. Along with this informal description, we formally specify this
model by means of Data-Flow Equations and rules of Operational Semantics,
making this the reference specification of the tangent and adjoint modes of
Tapenade. One benefit we expect from this formal specification is the capacity
to study formally the AD model itself, especially for the adjoint mode and its
sophisticated strategies. This paper also describes the architectural choices
of the implementation of Tapenade. We describe the current performances of
Tapenade on a set of codes that include industrial-size applications. We
present the extensions of the tool that are planned in a foreseeable future,
deriving from our ongoing research on AD.
</p>
</blockquote></li>
</ul>
</div>
</div>


<div id="outline-container-orgb15f30e" class="outline-3">
<h3 id="orgb15f30e"><span class="section-number-3">2.2</span> general considerations</h3>
<div class="outline-text-3" id="text-2-2">
<p>
As emphasized by Spivak cit:calculusOnManifolds and Elliot <a class='org-ref-reference' href="#elliott18">elliott18</a>
the derivative of a function between vector spaces can be succintly defined
as its linear approximation at a point. Since linear maps can be identified
with matrices in finite dimensional cases we often identify the derivative of
a function say,
</p>

<p>
$ f \mathbb R<sup>m</sup> &rarr; \mathbb R<sup>n</sup> $
</p>

<p>
with a matrix in \[\mathbb R^{m\times n} \] which we call the <i>Jacobian</i>
</p>

<p>
Depending on the context it might be more efficient to compute the adjoint to
the derivative of a function. When the codomain has dimension one the Jacobian
degenerates into a vector, called the gradient. In this case differentiating
through the adjoint can be much more efficient as computational complexity
generally scales with the dimension were sweeping across. Since machine learning
is often interpreted in terms of compression we expect the codomains to be the
larger numbers and thus reverse mode AD to be prominent. Indeed it is and they
call it backpropagation.
</p>

<p>
We can choose to take the coordinate view or the more abtract linear map
depending on the context. The problem with always identifying derivatives
with matrices, gradients or scalars instead of linear maps is that we loose
some structure and lead to some classical mistakes:
</p>

<p>
from wikipedia:
</p>
<blockquote>
<p>
The gradient is closely related to the derivative, but it is not itself a
derivative: the value of the gradient at a point is a tangent vector – a vector
at each point; while the value of the derivative at a point is a cotangent
vector – a function of vectors at each point.[c] They are related in that the
dot product of the gradient of f at a point p with another tangent vector v
equals the directional derivative of f at p of the function along v. See §
Definition and relationship with the derivative. The nabla symbol, a character
that looks like an upside down triangle, shown above is called Del, the vector
differential operator.
</p>
</blockquote>

<p>
the value of the gradient at a point is a tangent vector – a vector
at each point; while the value of the derivative at a point is a cotangent
vector – a function of vectors at each point.
</p>

<p>
Indeed in the literature one of the main hurdles in automatic differentiation
is not actually differentiation itself, the chain rule is indeed easy. What is
harder is <i>efficiently taking adjoints</i>. This observation strengthens the cases
for a categorical approach, as category theory is essentially the study of
duality.
</p>
</div>
</div>

<div id="outline-container-org5d6b7a4" class="outline-3">
<h3 id="org5d6b7a4"><span class="section-number-3">2.3</span> the mainstream/industry now</h3>
<div class="outline-text-3" id="text-2-3">
</div>
<div id="outline-container-orgaa493f4" class="outline-4">
<h4 id="orgaa493f4"><span class="section-number-4">2.3.1</span> tapenade</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
<a class='org-ref-reference' href="#Hascoet2013TTA">Hascoet2013TTA</a>
</p>
</div>
</div>

<div id="outline-container-org1878b14" class="outline-4">
<h4 id="org1878b14"><span class="section-number-4">2.3.2</span> tensorflow</h4>
</div>
</div>

<div id="outline-container-orgb3c5989" class="outline-3">
<h3 id="orgb3c5989"><span class="section-number-3">2.4</span> functional programming approach</h3>
</div>

<div id="outline-container-org3420ffb" class="outline-3">
<h3 id="org3420ffb"><span class="section-number-3">2.5</span> bib</h3>
<div class="outline-text-3" id="text-2-5">
<p>
<h1 class='org-ref-bib-h1'>Bibliography</h1>
<ul class='org-ref-bib'><li><a id="Pearlmutter_2008">[Pearlmutter_2008]</a> <a name="Pearlmutter_2008"></a>Pearlmutter & Siskind, Reverse-mode AD in a functional framework, <i>ACM Transactions on Programming Languages and Systems</i>, <b>30(2)</b>, 1–36 (2008). <a href="http://dx.doi.org/10.1145/1330017.1330018">link</a>. <a href="http://dx.doi.org/10.1145/1330017.1330018">doi</a>.</li>
<li><a id="array2019">[array2019]</a> <a name="array2019"></a>Amir Shaikhha, Andrew Fitzgibbon, Dimitrios, Vytiniotis & Simon Peyton Jones, Efficient differentiable programming in a functional  array-processing language, <i>Proceedings of the ACM on Programming Languages</i>, <b>3(ICFP)</b>, 1-30 (2019). <a href="http://dx.doi.org/10.1145/3341701">link</a>. <a href="http://dx.doi.org/10.1145/3341701">doi</a>.</li>
<li><a id="autoDiffInML2018">[autoDiffInML2018]</a> <a name="autoDiffInML2018"></a>@incollectionautoDiffInML2018,
  title           = Automatic differentiation in ML: Where we are and where we
                  should be going,
  author          = van Merrienboer, Bart and Breuleux, Olivier and Bergeron,
                  Arnaud and Lamblin, Pascal,
  booktitle       = Advances in Neural Information Processing Systems 31,
  editor          = S. Bengio and H. Wallach and H. Larochelle and K. Grauman
                  and N. Cesa-Bianchi and R. Garnett,
  pages           = 8757-8767,
  year            = 2018,
  publisher       = Curran Associates, Inc.,
  url             =
                  http://papers.nips.cc/paper/8092-automatic-differentiation-in-ml-where-we-are-and-where-we-should-be-going.pdf
</li>
<li><a id="innes2018dont">[innes2018dont]</a> <a name="innes2018dont"></a>@miscinnes2018dont,
  title           = Don't Unroll Adjoint: Differentiating SSA-Form Programs,
  author          = Michael Innes,
  year            = 2018,
  eprint          = 1810.07951,
  archivePrefix   = arXiv,
  primaryClass    = cs.PL
</li>
<li><a id="elliott18">[elliott18]</a> <a name="elliott18"></a>@Onlineelliott18,
  author          = Conal Elliott,
  title           = The simple essence of automatic differentiation,
  year            = 2018,
  archiveprefix   = arXiv,
  eprint          = 1804.00746v4,
  primaryclass    = cs.PL
</li>
<li><a id="elliott17_compil_to_categ">[elliott17_compil_to_categ]</a> <a name="elliott17_compil_to_categ"></a>Conal Elliott, Compiling To Categories, <i>Proceedings of the ACM on Programming Languages</i>, <b>1(ICFP)</b>, 1-27 (2017). <a href="https://doi.org/10.1145/3110271">link</a>. <a href="http://dx.doi.org/10.1145/3110271">doi</a>.</li>
<li><a id="Hascoet2013TTA">[Hascoet2013TTA]</a> <a name="Hascoet2013TTA"></a>"Hasco\"et & Pascual, The Tapenade Automatic Differentiation tool:  Principles, Model, and Specification, <i>"ACM Transactions on Mathematical Software"</i>, <b>39(3)</b>, 20:1-20:43 (2013). <a href="http://dx.doi.org/10.1145/2450153.2450158">link</a>.</li>
</ul>

</p>
</div>
</div>
</div>

<div id="outline-container-org7870a57" class="outline-2">
<h2 id="org7870a57"><span class="section-number-2">3</span> code</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org08f86ea" class="outline-3">
<h3 id="org08f86ea"><span class="section-number-3">3.1</span> structure of typer</h3>
<div class="outline-text-3" id="text-3-1">
</div>
<div id="outline-container-orgd4ddfaa" class="outline-4">
<h4 id="orgd4ddfaa"><span class="section-number-4">3.1.1</span> <a href="typer/">typer/</a></h4>
<div class="outline-text-4" id="text-3-1-1">
</div>
<div id="outline-container-org28f87b5" class="outline-5">
<h5 id="org28f87b5"><span class="section-number-5">3.1.1.1</span> <a href="typer/.git">.git</a></h5>
</div>
<div id="outline-container-org70ad23a" class="outline-5">
<h5 id="org70ad23a"><span class="section-number-5">3.1.1.2</span> <a href="typer/.gitignore">.gitignore</a></h5>
</div>
<div id="outline-container-org33c8823" class="outline-5">
<h5 id="org33c8823"><span class="section-number-5">3.1.1.3</span> <a href="typer/.travis.yml">.travis.yml</a></h5>
</div>
<div id="outline-container-org7d2945a" class="outline-5">
<h5 id="org7d2945a"><span class="section-number-5">3.1.1.4</span> <a href="typer/COPYING">COPYING</a></h5>
</div>
<div id="outline-container-org4690c1a" class="outline-5">
<h5 id="org4690c1a"><span class="section-number-5">3.1.1.5</span> <a href="typer/GNUmakefile">GNUmakefile</a></h5>
</div>
<div id="outline-container-org8a76168" class="outline-5">
<h5 id="org8a76168"><span class="section-number-5">3.1.1.6</span> <a href="typer/README.md">README.md</a></h5>
</div>
<div id="outline-container-org9de9a00" class="outline-5">
<h5 id="org9de9a00"><span class="section-number-5">3.1.1.7</span> <a href="typer/btl/">btl/</a></h5>
<div class="outline-text-5" id="text-3-1-1-7">
</div>
<ol class="org-ol">
<li><a id="orgdedd203"></a><a href="typer/btl/builtins.typer">builtins.typer</a><br /></li>
<li><a id="orgb4e1b36"></a><a href="typer/btl/pervasive.typer">pervasive.typer</a><br /></li>
</ol>
</div>
<div id="outline-container-org4317a64" class="outline-5">
<h5 id="org4317a64"><span class="section-number-5">3.1.1.8</span> <a href="typer/doc/">doc/</a></h5>
<div class="outline-text-5" id="text-3-1-1-8">
</div>
<ol class="org-ol">
<li><a id="org89e6a29"></a><a href="typer/doc/Compiler Structure.md">Compiler Structure.md</a><br /></li>
<li><a id="org7b0aed8"></a><a href="typer/doc/formal/">formal/</a><br />
<ol class="org-ol">
<li><a id="org62de1fa"></a><a href="typer/doc/formal/commands.tex">commands.tex</a><br /></li>
<li><a id="org621ad09"></a><a href="typer/doc/formal/typer_theory.bib">typer<sub>theory.bib</sub></a><br /></li>
<li><a id="orgb9df9b7"></a><a href="typer/doc/formal/typer_theory.tex">typer<sub>theory.tex</sub></a><br /></li>
</ol>
</li>
<li><a id="orgaf0cd25"></a><a href="typer/doc/manual.texi">manual.texi</a><br /></li>
<li><a id="org7f2c324"></a><a href="typer/doc/primer.md">primer.md</a><br /></li>
</ol>
</div>
<div id="outline-container-orgb6a9c4b" class="outline-5">
<h5 id="orgb6a9c4b"><span class="section-number-5">3.1.1.9</span> <a href="typer/emacs/">emacs/</a></h5>
<div class="outline-text-5" id="text-3-1-1-9">
</div>
<ol class="org-ol">
<li><a id="orgecc77c8"></a><a href="typer/emacs/typer-mode.el">typer-mode.el</a><br /></li>
</ol>
</div>
<div id="outline-container-org3e53123" class="outline-5">
<h5 id="org3e53123"><span class="section-number-5">3.1.1.10</span> <a href="typer/opam">opam</a></h5>
</div>
<div id="outline-container-org7d6f9b1" class="outline-5">
<h5 id="org7d6f9b1"><span class="section-number-5">3.1.1.11</span> <a href="typer/src/">src/</a></h5>
<div class="outline-text-5" id="text-3-1-1-11">
</div>
<ol class="org-ol">
<li><a id="orgc540723"></a><a href="typer/src/REPL.ml">REPL.ml</a><br /></li>
<li><a id="org599ad22"></a><a href="typer/src/builtin.ml">builtin.ml</a><br /></li>
<li><a id="org90a870b"></a><a href="typer/src/debruijn.ml">debruijn.ml</a><br /></li>
<li><a id="org758ccda"></a><a href="typer/src/debug.ml">debug.ml</a><br /></li>
<li><a id="org6a52ccf"></a><a href="typer/src/debug_util.ml">debug<sub>util.ml</sub></a><br /></li>
<li><a id="orgddc02f7"></a><a href="typer/src/elab.ml">elab.ml</a><br /></li>
<li><a id="org0af8d82"></a><a href="typer/src/elexp.ml">elexp.ml</a><br /></li>
<li><a id="orga2dbe1b"></a><a href="typer/src/env.ml">env.ml</a><br /></li>
<li><a id="org05d1a1a"></a><a href="typer/src/eval.ml">eval.ml</a><br /></li>
<li><a id="org35dc146"></a><a href="typer/src/fmt.ml">fmt.ml</a><br /></li>
<li><a id="orgc5f4c7f"></a><a href="typer/src/grammar.ml">grammar.ml</a><br /></li>
<li><a id="org7500483"></a><a href="typer/src/lexer.ml">lexer.ml</a><br /></li>
<li><a id="orgb9d1564"></a><a href="typer/src/lexp.ml">lexp.ml</a><br /></li>
<li><a id="orgff2e14d"></a><a href="typer/src/log.ml">log.ml</a><br /></li>
<li><a id="org11a72c9"></a><a href="typer/src/myers.ml">myers.ml</a><br /></li>
<li><a id="orgdd4597d"></a><a href="typer/src/old/">old/</a><br />
<ol class="org-ol">
<li><a id="org3937fb8"></a><a href="typer/src/old/elaborate.ml">elaborate.ml</a><br /></li>
<li><a id="orge1fe56b"></a><a href="typer/src/old/javascript.ml">javascript.ml</a><br /></li>
<li><a id="org3cb168f"></a><a href="typer/src/old/ulexp.ml">ulexp.ml</a><br /></li>
<li><a id="org314b963"></a><a href="typer/src/old/unify.ml">unify.ml</a><br /></li>
</ol>
</li>
<li><a id="org9ae480f"></a><a href="typer/src/opslexp.ml">opslexp.ml</a><br /></li>
<li><a id="org02191e1"></a><a href="typer/src/pexp.ml">pexp.ml</a><br /></li>
<li><a id="org52f407b"></a><a href="typer/src/prelexer.ml">prelexer.ml</a><br /></li>
<li><a id="org20eaff0"></a><a href="typer/src/sexp.ml">sexp.ml</a><br /></li>
<li><a id="org30969de"></a><a href="typer/src/subst.ml">subst.ml</a><br /></li>
<li><a id="orgcfaa76c"></a><a href="typer/src/tweak.ml">tweak.ml</a><br /></li>
<li><a id="orgd97ed22"></a><a href="typer/src/util.ml">util.ml</a><br /></li>
</ol>
</div>
<div id="outline-container-orgaabfb1b" class="outline-5">
<h5 id="orgaabfb1b"><span class="section-number-5">3.1.1.12</span> <a href="typer/tests/">tests/</a></h5>
<div class="outline-text-5" id="text-3-1-1-12">
</div>
<ol class="org-ol">
<li><a id="org933df63"></a><a href="typer/tests/elab_test.ml">elab<sub>test.ml</sub></a><br /></li>
<li><a id="org6329537"></a><a href="typer/tests/env_test.ml">env<sub>test.ml</sub></a><br /></li>
<li><a id="orgbd74a59"></a><a href="typer/tests/eval_test.ml">eval<sub>test.ml</sub></a><br /></li>
<li><a id="orgfbb0df2"></a><a href="typer/tests/lexp_test.ml">lexp<sub>test.ml</sub></a><br /></li>
<li><a id="org7dbc1c9"></a><a href="typer/tests/macro_test.ml">macro<sub>test.ml</sub></a><br /></li>
<li><a id="org4dc8b15"></a><a href="typer/tests/sexp_test.ml">sexp<sub>test.ml</sub></a><br /></li>
<li><a id="orgffd5267"></a><a href="typer/tests/utest_lib.ml">utest<sub>lib.ml</sub></a><br /></li>
<li><a id="org5fa6e5b"></a><a href="typer/tests/utest_main.ml">utest<sub>main.ml</sub></a><br /></li>
</ol>
</div>
</div>

<div id="outline-container-org249da12" class="outline-4">
<h4 id="org249da12"><span class="section-number-4">3.1.2</span> reverse engineering&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notmine">notmine</span></span></h4>
<div class="outline-text-4" id="text-3-1-2">
</div>
<div id="outline-container-org8997518" class="outline-5">
<h5 id="org8997518"><span class="section-number-5">3.1.2.1</span> util</h5>
<div class="outline-text-5" id="text-3-1-2-1">
</div>
<ol class="org-ol">
<li><a id="orgc8fa18f"></a>first<br />
<div class="outline-text-6" id="text-3-1-2-1-1">
<p>
map module and file type declaration
</p>
<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">module</span> <span style="color: #ECCC87;">SMap</span> = <span style="color: #ECCC87;">Map.Make </span><span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">String</span><span style="color: #80A0C2;">)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">smap_find_opt</span> <span style="color: #dac6d6;">s</span> <span style="color: #dac6d6;">m</span> = <span style="color: #80A0C2;">try</span> <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">SMap.</span>find s m<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">with</span> <span style="color: #8EBCBB;">Not_found</span> -&gt; <span style="color: #ECEFF4; background-color: #2E3440;">None</span> <span style="color: #6f7787;">(*</span><span style="color: #6f7787;">debian stuff</span><span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">module</span> <span style="color: #ECCC87;">IMap</span> = <span style="color: #ECCC87;">Map.Make</span> <span style="color: #80A0C2;">(</span><span style="color: #f5deb3; font-weight: bold;">struct</span> <span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">t</span> = int <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">compare</span> = compare <span style="color: #f5deb3; font-weight: bold;">end</span><span style="color: #80A0C2;">)</span> <span style="color: #6f7787;">(*</span><span style="color: #6f7787;">int map</span><span style="color: #6f7787;">*)</span>

<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">charpos</span> = int
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">bytepos</span> = int
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">location</span> = <span style="color: #80A0C2;">{</span> file : string;
                  line : int;
                  column : charpos;
                  docstr : string;
                <span style="color: #80A0C2;">}</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">dummy_location</span> = <span style="color: #80A0C2;">{</span>file=<span style="color: #A2BF8A;">""</span>; line=<span style="color: #B58DAE; font-weight: bold;">0</span>; column=<span style="color: #B58DAE; font-weight: bold;">0</span>; docstr=<span style="color: #A2BF8A;">""</span><span style="color: #80A0C2;">}</span>
</pre>
</div>
</div>
</li>

<li><a id="org2c14692"></a>then<br />
<div class="outline-text-6" id="text-3-1-2-1-2">
<dl class="org-dl">
<dt>what it do</dt><dd>types for parse tree</dd>
</dl>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">vname</span> = location * string option
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">db_index</span> = int             <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">DeBruijn index.  </span><span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">db_offset</span> = int            <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">DeBruijn index offset.  </span><span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">db_revindex</span> = int          <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">DeBruijn index counting from the root.  </span><span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">vref</span> = <span style="color: #80A0C2;">(</span>location * string list<span style="color: #80A0C2;">)</span> * db_index
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">bottom</span> = | <span style="color: #ECEFF4; background-color: #2E3440;">B_o_t_t_o_m_</span> <span style="color: #80A0C2;">of</span> bottom
</pre>
</div>
</div>
</li>

<li><a id="org9b4df10"></a>then<br />
<div class="outline-text-6" id="text-3-1-2-1-3">
<dl class="org-dl">
<dt>what it do</dt><dd>printing stuff</dd>
<dt>(no term)</dt><dd>libraries :
<dl class="org-dl">
<dt><a href="https://opam.ocaml.org/packages/fmt/">fmt</a></dt><dd>format pretty printer combinators</dd>
</dl></dd>
</dl>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">loc_string</span> <span style="color: #dac6d6;">loc</span> =
  <span style="color: #A2BF8A;">"Ln "</span> <span style="color: #f0e68c;">^</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Fmt.</span>ralign_int loc.line <span style="color: #B58DAE; font-weight: bold;">3</span><span style="color: #80A0C2;">)</span> <span style="color: #f0e68c;">^</span> <span style="color: #A2BF8A;">", cl "</span> <span style="color: #f0e68c;">^</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Fmt.</span>ralign_int loc.column <span style="color: #B58DAE; font-weight: bold;">3</span><span style="color: #80A0C2;">)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">loc_print</span> <span style="color: #dac6d6;">loc</span> = print_string <span style="color: #80A0C2;">(</span>loc_string loc<span style="color: #80A0C2;">)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">string_implode</span> <span style="color: #dac6d6;">chars</span> = <span style="color: #ECCC87;">String.</span>concat <span style="color: #A2BF8A;">""</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">List.</span>map <span style="color: #B58DAE;">(</span><span style="color: #ECCC87;">String.</span>make <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">)</span> chars<span style="color: #80A0C2;">)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">string_sub</span> <span style="color: #dac6d6;">str</span> <span style="color: #dac6d6;">b</span> <span style="color: #dac6d6;">e</span> = <span style="color: #ECCC87;">String.</span>sub str b <span style="color: #80A0C2;">(</span>e - b<span style="color: #80A0C2;">)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">string_uppercase</span> <span style="color: #dac6d6;">s</span> = <span style="color: #ECCC87;">String.</span>uppercase s
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">opt_map</span> <span style="color: #dac6d6;">f</span> <span style="color: #dac6d6;">x</span> = <span style="color: #80A0C2;">match</span> x <span style="color: #80A0C2;">with</span> <span style="color: #ECEFF4; background-color: #2E3440;">None</span> -&gt; <span style="color: #ECEFF4; background-color: #2E3440;">None</span> | <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> x -&gt; <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #80A0C2;">(</span>f x<span style="color: #80A0C2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml" id="orgbb2b7ed"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">str_split</span> <span style="color: #dac6d6;">str</span> <span style="color: #dac6d6;">sep</span> =
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">str</span> = <span style="color: #ECCC87;">String.</span>trim str <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">n</span> = <span style="color: #ECCC87;">String.</span>length str <span style="color: #f5deb3; font-weight: bold;">in</span>

  <span style="color: #80A0C2;">if</span> n = <span style="color: #B58DAE; font-weight: bold;">0</span> <span style="color: #80A0C2;">then</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span>
  <span style="color: #80A0C2;">else</span> <span style="color: #80A0C2;">(</span>
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">ret</span> = <span style="color: #8EBCBB;">ref</span> <span style="color: #B58DAE; background-color: #2E3440;">[]</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">buffer</span> = <span style="color: #ECCC87;">Buffer.</span>create <span style="color: #B58DAE; font-weight: bold;">10</span> <span style="color: #f5deb3; font-weight: bold;">in</span> <span style="color: #ECCC87;">Buffer.</span>add_char buffer <span style="color: #B58DAE;">(</span>str.<span style="color: #A2BF8A;">[</span><span style="color: #B58DAE; font-weight: bold;">0</span><span style="color: #A2BF8A;">]</span><span style="color: #B58DAE;">)</span>;

    <span style="color: #80A0C2;">for</span> i = <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #80A0C2;">to</span> n - <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #80A0C2;">do</span>
      <span style="color: #80A0C2;">if</span> str.<span style="color: #B58DAE;">[</span>i<span style="color: #B58DAE;">]</span> = sep <span style="color: #80A0C2;">then</span> <span style="color: #B58DAE;">(</span>
        ret := <span style="color: #A2BF8A;">(</span><span style="color: #ECCC87;">Buffer.</span>contents buffer<span style="color: #A2BF8A;">)</span><span style="color: #ECEFF4; background-color: #2E3440;">::</span><span style="color: #A2BF8A;">(</span><span style="color: #f0e68c;">!</span>ret<span style="color: #A2BF8A;">)</span>;
        <span style="color: #ECCC87;">Buffer.</span>reset buffer<span style="color: #B58DAE;">)</span>
      <span style="color: #80A0C2;">else</span>
        <span style="color: #ECCC87;">Buffer.</span>add_char buffer <span style="color: #B58DAE;">(</span>str.<span style="color: #A2BF8A;">[</span>i<span style="color: #A2BF8A;">]</span><span style="color: #B58DAE;">)</span>;
    <span style="color: #80A0C2;">done</span>;

    <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #A2BF8A;">(</span><span style="color: #ECCC87;">Buffer.</span>length buffer<span style="color: #A2BF8A;">)</span> &gt; <span style="color: #B58DAE; font-weight: bold;">0</span> <span style="color: #80A0C2;">then</span>
       ret := <span style="color: #A2BF8A;">(</span><span style="color: #ECCC87;">Buffer.</span>contents buffer<span style="color: #A2BF8A;">)</span><span style="color: #ECEFF4; background-color: #2E3440;">::</span><span style="color: #A2BF8A;">(</span><span style="color: #f0e68c;">!</span>ret<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>;

    <span style="color: #ECCC87;">List.</span>rev <span style="color: #B58DAE;">(</span><span style="color: #f0e68c;">!</span>ret<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml" id="orgb7e54c2"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">utf8_head_p</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">c</span> :<span style="color: #ECCC87;"> char</span><span style="color: #80A0C2;">)</span> :<span style="color: #ECCC87;"> bool</span>
<span style="color: #ECCC87;">  </span>= <span style="color: #ECCC87;">Char.</span>code c &lt; <span style="color: #B58DAE; font-weight: bold;">128</span> <span style="color: #f0e68c;">||</span> <span style="color: #ECCC87;">Char.</span>code c &gt;= <span style="color: #B58DAE; font-weight: bold;">192</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #6f7787;">(* </span><span style="color: #6f7787;">Display size of `str`, assuming the byte-sequence is UTF-8.</span>
<span style="color: #6f7787;"> * Very naive: doesn't pay attention to LF, TABs, double-width chars, ...  </span><span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">string_width</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">s</span> :<span style="color: #ECCC87;"> string</span><span style="color: #80A0C2;">)</span> :<span style="color: #ECCC87;"> int </span>=
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">width</span> <span style="color: #dac6d6;">i</span> <span style="color: #dac6d6;">w</span> =
    <span style="color: #80A0C2;">if</span> i &lt; <span style="color: #B58DAE; font-weight: bold;">0</span> <span style="color: #80A0C2;">then</span> w
    <span style="color: #80A0C2;">else</span> width <span style="color: #80A0C2;">(</span>i - <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span>
        <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">if</span> utf8_head_p <span style="color: #B58DAE;">(</span><span style="color: #ECCC87;">String.</span>get s i<span style="color: #B58DAE;">)</span>
         <span style="color: #80A0C2;">then</span> w + <span style="color: #B58DAE; font-weight: bold;">1</span>
         <span style="color: #80A0C2;">else</span> w<span style="color: #80A0C2;">)</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
  width <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">String.</span>length s - <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #B58DAE; font-weight: bold;">0</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">padding_right</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">str</span>:<span style="color: #ECCC87;"> string </span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">dim</span>:<span style="color: #ECCC87;"> int </span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">char_</span>:<span style="color: #ECCC87;"> char</span><span style="color: #80A0C2;">)</span> :<span style="color: #ECCC87;"> string </span>=
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">diff</span> = <span style="color: #80A0C2;">(</span>dim - string_width str<span style="color: #80A0C2;">)</span>
  <span style="color: #f5deb3; font-weight: bold;">in</span> <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">rpad</span> = max diff <span style="color: #B58DAE; font-weight: bold;">0</span>
  <span style="color: #f5deb3; font-weight: bold;">in</span> str <span style="color: #f0e68c;">^</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">String.</span>make rpad char_<span style="color: #80A0C2;">)</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">padding_left</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">str</span>:<span style="color: #ECCC87;"> string </span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">dim</span>:<span style="color: #ECCC87;"> int </span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">char_</span>:<span style="color: #ECCC87;"> char</span><span style="color: #80A0C2;">)</span> :<span style="color: #ECCC87;"> string </span>=
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">diff</span> = <span style="color: #80A0C2;">(</span>dim - string_width str<span style="color: #80A0C2;">)</span>
  <span style="color: #f5deb3; font-weight: bold;">in</span> <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">lpad</span> = max diff <span style="color: #B58DAE; font-weight: bold;">0</span>
  <span style="color: #f5deb3; font-weight: bold;">in</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">String.</span>make lpad char_<span style="color: #80A0C2;">)</span> <span style="color: #f0e68c;">^</span> str

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">option_default</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">default</span> :<span style="color: #ECCC87;"> 'a</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">opt</span> :<span style="color: #ECCC87;"> 'a option</span><span style="color: #80A0C2;">)</span> :<span style="color: #ECCC87;"> 'a </span>=
  <span style="color: #80A0C2;">match</span> opt <span style="color: #80A0C2;">with</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">None</span> -&gt; default
  | <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> x -&gt; x

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">option_map</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">fn</span> :<span style="color: #ECCC87;"> 'a -&gt; 'b</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">opt</span> :<span style="color: #ECCC87;"> 'a option</span><span style="color: #80A0C2;">)</span> :<span style="color: #ECCC87;"> 'b option </span>=
  <span style="color: #80A0C2;">match</span> opt <span style="color: #80A0C2;">with</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">None</span> -&gt; <span style="color: #ECEFF4; background-color: #2E3440;">None</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> x -&gt; <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #80A0C2;">(</span>fn x<span style="color: #80A0C2;">)</span>

</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org9c08c8a" class="outline-5">
<h5 id="org9c08c8a"><span class="section-number-5">3.1.2.2</span> prelexer</h5>
<div class="outline-text-5" id="text-3-1-2-2">
<p>
The prelexer outlines nested block structure of program so that
we don&rsquo;t have to recursively traverse all of the blocks at once.
</p>

<div class="org-src-container">
<pre class="src src-ocaml" id="org34e1c42"><span style="color: #6f7787;">(* </span><span style="color: #6f7787;">FIXME: Add syntax for char constants (maybe 'c').  </span><span style="color: #6f7787;">*)</span>
<span style="color: #6f7787;">(* </span><span style="color: #6f7787;">FIXME: Handle multiline strings.  </span><span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">open </span><span style="color: #ECCC87;">Util</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">prelexer_error</span> <span style="color: #dac6d6;">loc</span> = <span style="color: #ECCC87;">Log.</span>log_error <span style="color: #B58DAE;">~section</span>:<span style="color: #A2BF8A;">"PRELEXER"</span> ~loc

<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">pretoken</span> =
  | <span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span> <span style="color: #80A0C2;">of</span> location * string
  | <span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> <span style="color: #80A0C2;">of</span> location * string
  | <span style="color: #ECEFF4; background-color: #2E3440;">Preblock</span> <span style="color: #80A0C2;">of</span> location * pretoken list * location

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">inc_cp</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">cp</span>:<span style="color: #ECCC87;">charpos</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">c</span>:<span style="color: #ECCC87;">char</span><span style="color: #80A0C2;">)</span> =
  <span style="color: #80A0C2;">if</span> utf8_head_p c <span style="color: #80A0C2;">then</span> cp+<span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #80A0C2;">else</span> cp

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">prelex</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">file</span> :<span style="color: #ECCC87;"> string</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">getline</span> :<span style="color: #ECCC87;"> unit -&gt; string</span><span style="color: #80A0C2;">)</span> <span style="color: #dac6d6;">ln</span> <span style="color: #dac6d6;">ctx</span> <span style="color: #dac6d6;">acc</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">doc</span> :<span style="color: #ECCC87;"> string</span><span style="color: #80A0C2;">)</span>
  : pretoken list =
  <span style="color: #80A0C2;">try</span>
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">line</span> = getline <span style="color: #80A0C2;">()</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">limit</span> = <span style="color: #ECCC87;">String.</span>length line <span style="color: #f5deb3; font-weight: bold;">in</span>
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">nextline</span> = prelex file getline <span style="color: #80A0C2;">(</span>ln + <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">prelex'</span> <span style="color: #dac6d6;">ctx</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">bpos</span>:<span style="color: #ECCC87;">bytepos</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">cpos</span>:<span style="color: #ECCC87;">charpos</span><span style="color: #80A0C2;">)</span> <span style="color: #dac6d6;">acc</span> <span style="color: #dac6d6;">doc</span> =
      <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">nexttok</span> = prelex' ctx <span style="color: #f5deb3; font-weight: bold;">in</span>
      <span style="color: #80A0C2;">if</span> bpos &gt;= limit <span style="color: #80A0C2;">then</span> nextline ctx acc doc
      <span style="color: #80A0C2;">else</span>
        <span style="color: #80A0C2;">match</span> line.<span style="color: #80A0C2;">[</span>bpos<span style="color: #80A0C2;">]</span> <span style="color: #80A0C2;">with</span>
        | c <span style="color: #80A0C2;">when</span> c &lt;= <span style="color: #A2BF8A;">' '</span> -&gt; nexttok <span style="color: #80A0C2;">(</span>bpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>cpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> acc doc
        | <span style="color: #A2BF8A;">'%'</span> -&gt; nextline ctx acc doc <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">A comment.  </span><span style="color: #6f7787;">*)</span>
        <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">line's bounds seems ok: String.sub line 1 0 == "" </span><span style="color: #6f7787;">*)</span>
        | <span style="color: #A2BF8A;">'@'</span> -&gt; nextline ctx acc <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">String.</span>concat <span style="color: #A2BF8A;">"\n"</span> <span style="color: #B58DAE;">[</span>doc; <span style="color: #A2BF8A;">(</span><span style="color: #ECCC87;">String.</span>sub line <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #80A0C2;">(</span>limit - <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">]</span><span style="color: #80A0C2;">)</span>
        | <span style="color: #A2BF8A;">'"'</span>                         <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">A string.  </span><span style="color: #6f7787;">*)</span>
          -&gt; <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">prestring</span> <span style="color: #dac6d6;">bp</span> <span style="color: #dac6d6;">cp</span> <span style="color: #dac6d6;">chars</span> =
               <span style="color: #80A0C2;">if</span> bp &gt;= limit <span style="color: #80A0C2;">then</span>
                 <span style="color: #80A0C2;">(</span>prelexer_error <span style="color: #B58DAE;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #B58DAE;">}</span>
                    <span style="color: #A2BF8A;">"Unterminated string"</span>;
                  nextline ctx
                    <span style="color: #B58DAE;">(</span><span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #80A0C2;">}</span>, <span style="color: #A2BF8A;">""</span><span style="color: #A2BF8A;">)</span>
                     <span style="color: #ECEFF4; background-color: #2E3440;">::</span> acc<span style="color: #B58DAE;">)</span> <span style="color: #A2BF8A;">""</span><span style="color: #80A0C2;">)</span>
               <span style="color: #80A0C2;">else</span>
                 <span style="color: #80A0C2;">match</span> line.<span style="color: #80A0C2;">[</span>bp<span style="color: #80A0C2;">]</span> <span style="color: #80A0C2;">with</span>
                 | <span style="color: #A2BF8A;">'"'</span> -&gt;
                   nexttok <span style="color: #80A0C2;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>cp+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span>
                     <span style="color: #80A0C2;">(</span><span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #A2BF8A;">}</span>,
                                 string_implode <span style="color: #A2BF8A;">(</span><span style="color: #ECCC87;">List.</span>rev chars<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                      <span style="color: #ECEFF4; background-color: #2E3440;">::</span> acc<span style="color: #80A0C2;">)</span> <span style="color: #A2BF8A;">""</span>
                 | <span style="color: #A2BF8A;">'\\'</span> -&gt;
                   <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">if</span> bpos + <span style="color: #B58DAE; font-weight: bold;">1</span> &gt;= limit <span style="color: #80A0C2;">then</span>
                      <span style="color: #B58DAE;">(</span>prelexer_error <span style="color: #A2BF8A;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #A2BF8A;">}</span>
                         <span style="color: #A2BF8A;">"Unterminated string"</span>;
                       nextline ctx
                         <span style="color: #A2BF8A;">(</span><span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #B58DAE;">}</span>,
                                     <span style="color: #A2BF8A;">""</span><span style="color: #80A0C2;">)</span>
                          <span style="color: #ECEFF4; background-color: #2E3440;">::</span> acc<span style="color: #A2BF8A;">)</span> <span style="color: #A2BF8A;">""</span><span style="color: #B58DAE;">)</span>
                    <span style="color: #80A0C2;">else</span>
                      <span style="color: #80A0C2;">match</span> line.<span style="color: #B58DAE;">[</span>bp + <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">]</span> <span style="color: #80A0C2;">with</span>
                      | <span style="color: #A2BF8A;">'t'</span> -&gt; prestring <span style="color: #B58DAE;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>cp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">'\t'</span> <span style="color: #ECEFF4; background-color: #2E3440;">::</span> chars<span style="color: #B58DAE;">)</span>
                      | <span style="color: #A2BF8A;">'n'</span> -&gt; prestring <span style="color: #B58DAE;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>cp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">'\n'</span> <span style="color: #ECEFF4; background-color: #2E3440;">::</span> chars<span style="color: #B58DAE;">)</span>
                      | <span style="color: #A2BF8A;">'r'</span> -&gt; prestring <span style="color: #B58DAE;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>cp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">'\r'</span> <span style="color: #ECEFF4; background-color: #2E3440;">::</span> chars<span style="color: #B58DAE;">)</span>
                      | <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">'u'</span> | <span style="color: #A2BF8A;">'U'</span><span style="color: #B58DAE;">)</span> -&gt;
                        prelexer_error <span style="color: #B58DAE;">{</span>file=file; line=ln; column=cp; docstr=doc<span style="color: #B58DAE;">}</span>
                          <span style="color: #A2BF8A;">"Unimplemented unicode escape"</span>;
                        prestring <span style="color: #B58DAE;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>cp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> chars
                      | char -&gt; prestring <span style="color: #B58DAE;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>cp+<span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>char <span style="color: #ECEFF4; background-color: #2E3440;">::</span> chars<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
                 | char -&gt; prestring <span style="color: #80A0C2;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>inc_cp cp char<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>char <span style="color: #ECEFF4; background-color: #2E3440;">::</span> chars<span style="color: #80A0C2;">)</span>
          <span style="color: #f5deb3; font-weight: bold;">in</span> prestring <span style="color: #80A0C2;">(</span>bpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>cpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span>
        | <span style="color: #A2BF8A;">'{'</span> -&gt; prelex' <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>ln, cpos, bpos, acc<span style="color: #B58DAE;">)</span> <span style="color: #ECEFF4; background-color: #2E3440;">::</span> ctx<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>bpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>cpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span> doc
        | <span style="color: #A2BF8A;">'}'</span>
          -&gt; <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">match</span> ctx <span style="color: #80A0C2;">with</span>
              | <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>sln, scpos, sbpos, sacc<span style="color: #A2BF8A;">)</span> <span style="color: #ECEFF4; background-color: #2E3440;">::</span> ctx<span style="color: #B58DAE;">)</span> -&gt;
                prelex' ctx <span style="color: #B58DAE;">(</span>bpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span>cpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">)</span>
                  <span style="color: #B58DAE;">(</span><span style="color: #ECEFF4; background-color: #2E3440;">Preblock</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">{</span>file=file; line=sln; column=scpos; docstr=doc<span style="color: #80A0C2;">}</span>,
                             <span style="color: #ECCC87;">List.</span>rev acc,
                             <span style="color: #80A0C2;">{</span>file=file; line=ln; column=<span style="color: #B58DAE;">(</span>cpos + <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">)</span>; docstr=doc<span style="color: #80A0C2;">}</span><span style="color: #A2BF8A;">)</span>
                   <span style="color: #ECEFF4; background-color: #2E3440;">::</span> sacc<span style="color: #B58DAE;">)</span> <span style="color: #A2BF8A;">""</span>
              | _ -&gt; <span style="color: #B58DAE;">(</span>prelexer_error <span style="color: #A2BF8A;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #A2BF8A;">}</span>
                        <span style="color: #A2BF8A;">"Unmatched closing brace"</span>;
                      prelex' ctx <span style="color: #A2BF8A;">(</span>bpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #A2BF8A;">)</span> <span style="color: #A2BF8A;">(</span>cpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #A2BF8A;">)</span> acc doc<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
        | char                  <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">A pretoken.  </span><span style="color: #6f7787;">*)</span>
          -&gt; <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">pretok</span> <span style="color: #dac6d6;">bp</span> <span style="color: #dac6d6;">cp</span> =
               <span style="color: #80A0C2;">if</span> bp &gt;= limit <span style="color: #80A0C2;">then</span>
                 nextline ctx <span style="color: #80A0C2;">(</span><span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #A2BF8A;">}</span>,
                                         string_sub line bpos bp<span style="color: #B58DAE;">)</span>
                               <span style="color: #ECEFF4; background-color: #2E3440;">::</span> acc<span style="color: #80A0C2;">)</span> <span style="color: #A2BF8A;">""</span>
               <span style="color: #80A0C2;">else</span>
                 <span style="color: #80A0C2;">match</span> line.<span style="color: #80A0C2;">[</span>bp<span style="color: #80A0C2;">]</span> <span style="color: #80A0C2;">with</span>
                 | <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">' '</span>|<span style="color: #A2BF8A;">'\t'</span>|<span style="color: #A2BF8A;">'\n'</span>|<span style="color: #A2BF8A;">'\r'</span>|<span style="color: #A2BF8A;">'%'</span>|<span style="color: #A2BF8A;">'"'</span>|<span style="color: #A2BF8A;">'{'</span>|<span style="color: #A2BF8A;">'}'</span> <span style="color: #80A0C2;">)</span>
                  -&gt; nexttok bp cp
                            <span style="color: #80A0C2;">(</span><span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">{</span>file=file; line=ln; column=cpos; docstr=doc<span style="color: #A2BF8A;">}</span>,
                                       string_sub line bpos bp<span style="color: #B58DAE;">)</span>
                             <span style="color: #ECEFF4; background-color: #2E3440;">::</span> acc<span style="color: #80A0C2;">)</span> <span style="color: #A2BF8A;">""</span>
                | <span style="color: #A2BF8A;">'\\'</span> <span style="color: #80A0C2;">when</span> bp+<span style="color: #B58DAE; font-weight: bold;">1</span> &lt; limit
                  -&gt; <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">char</span> = line.<span style="color: #80A0C2;">[</span>bp + <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">]</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
                    pretok <span style="color: #80A0C2;">(</span>bp + <span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE; font-weight: bold;">1</span> + inc_cp cp char<span style="color: #80A0C2;">)</span>
                | char -&gt; pretok <span style="color: #80A0C2;">(</span>bp+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>inc_cp cp char<span style="color: #80A0C2;">)</span>
            <span style="color: #f5deb3; font-weight: bold;">in</span> pretok <span style="color: #80A0C2;">(</span>bpos+<span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>inc_cp cpos char<span style="color: #80A0C2;">)</span>
    <span style="color: #f5deb3; font-weight: bold;">in</span> prelex' ctx <span style="color: #B58DAE; font-weight: bold;">0</span> <span style="color: #B58DAE; font-weight: bold;">1</span> acc doc <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">Traditionally, column numbers start at 1 :-(  </span><span style="color: #6f7787;">*)</span>
  <span style="color: #80A0C2;">with</span> <span style="color: #8EBCBB;">End_of_file</span> -&gt;
       <span style="color: #80A0C2;">match</span> ctx <span style="color: #80A0C2;">with</span>
         | <span style="color: #80A0C2; background-color: #2E3440;">[]</span> -&gt; <span style="color: #ECCC87;">List.</span>rev acc
         | <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>ln, cpos, _, _<span style="color: #B58DAE;">)</span> <span style="color: #ECEFF4; background-color: #2E3440;">::</span> ctx<span style="color: #80A0C2;">)</span> -&gt;
           <span style="color: #80A0C2;">(</span>prelexer_error <span style="color: #B58DAE;">{</span>file=file; line=ln; column=cpos; docstr=<span style="color: #A2BF8A;">""</span><span style="color: #B58DAE;">}</span>
                      <span style="color: #A2BF8A;">"Unmatched opening brace"</span>; <span style="color: #ECCC87;">List.</span>rev acc<span style="color: #80A0C2;">)</span>

</pre>
</div>

<div class="org-src-container">
<pre class="src src-ocaml" id="org23069d9"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">prelex_file</span> <span style="color: #dac6d6;">file</span> =
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">fin</span> = open_in file
  <span style="color: #f5deb3; font-weight: bold;">in</span> prelex file <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">fun</span> <span style="color: #dac6d6;">_</span> -&gt; input_line fin<span style="color: #80A0C2;">)</span>
    <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">Traditionally, line numbers start at 1 :-(  </span><span style="color: #6f7787;">*)</span>
    <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span> <span style="color: #A2BF8A;">""</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">prelex_string</span> <span style="color: #dac6d6;">str</span> =
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">pos</span> = <span style="color: #8EBCBB;">ref</span> <span style="color: #B58DAE; font-weight: bold;">0</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">getline</span> <span style="color: #80A0C2;">()</span> =
    <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">start</span> = <span style="color: #f0e68c;">!</span>pos <span style="color: #f5deb3; font-weight: bold;">in</span>
    <span style="color: #80A0C2;">if</span> start &gt;= <span style="color: #ECCC87;">String.</span>length str <span style="color: #80A0C2;">then</span> <span style="color: #8EBCBB;">raise</span> <span style="color: #8EBCBB;">End_of_file</span> <span style="color: #80A0C2;">else</span>
      <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">i</span> = <span style="color: #80A0C2;">try</span> <span style="color: #ECCC87;">String.</span>index_from str start <span style="color: #A2BF8A;">'\n'</span>
        <span style="color: #80A0C2;">with</span> <span style="color: #8EBCBB;">Not_found</span> -&gt; <span style="color: #ECCC87;">String.</span>length str - <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
      <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">npos</span> = i + <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #f5deb3; font-weight: bold;">in</span>
      pos := npos;
      <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">line</span> = string_sub str start npos <span style="color: #f5deb3; font-weight: bold;">in</span>
      line
  <span style="color: #f5deb3; font-weight: bold;">in</span> prelex <span style="color: #A2BF8A;">"&lt;string&gt;"</span> getline <span style="color: #B58DAE; font-weight: bold;">1</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span> <span style="color: #80A0C2; background-color: #2E3440;">[]</span> <span style="color: #A2BF8A;">""</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">pretoken_name</span> <span style="color: #dac6d6;">pretok</span> =
  <span style="color: #80A0C2;">match</span> pretok <span style="color: #80A0C2;">with</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span>  _ -&gt; <span style="color: #A2BF8A;">"Pretoken"</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> _ -&gt; <span style="color: #A2BF8A;">"Prestring"</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Preblock</span>  _ -&gt; <span style="color: #A2BF8A;">"Preblock"</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">pretoken_string</span> <span style="color: #dac6d6;">pretok</span> =
  <span style="color: #80A0C2;">match</span> pretok <span style="color: #80A0C2;">with</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Preblock</span><span style="color: #80A0C2;">(</span>_,pts,_<span style="color: #80A0C2;">)</span> -&gt;
    <span style="color: #A2BF8A;">"{"</span> <span style="color: #f0e68c;">^</span> <span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">List.</span>fold_left <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">fun</span> <span style="color: #dac6d6;">str</span> <span style="color: #dac6d6;">pts</span> -&gt; str <span style="color: #f0e68c;">^</span> <span style="color: #A2BF8A;">" "</span> <span style="color: #f0e68c;">^</span> <span style="color: #A2BF8A;">(</span>pretoken_string pts<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span> <span style="color: #A2BF8A;">""</span> pts<span style="color: #80A0C2;">)</span> <span style="color: #f0e68c;">^</span> <span style="color: #A2BF8A;">" }"</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span><span style="color: #80A0C2;">(</span>_, str<span style="color: #80A0C2;">)</span>  -&gt; str
  | <span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span><span style="color: #80A0C2;">(</span>_, str<span style="color: #80A0C2;">)</span> -&gt; <span style="color: #A2BF8A;">"\""</span> <span style="color: #f0e68c;">^</span> str <span style="color: #f0e68c;">^</span> <span style="color: #A2BF8A;">"\""</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">pretokens_string</span> <span style="color: #dac6d6;">pretokens</span> =
  <span style="color: #ECCC87;">List.</span>fold_left <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">fun</span> <span style="color: #dac6d6;">str</span> <span style="color: #dac6d6;">pt</span> -&gt; str <span style="color: #f0e68c;">^</span> <span style="color: #B58DAE;">(</span>pretoken_string pt<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span> <span style="color: #A2BF8A;">""</span> pretokens

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #8EBCBB;">pretokens_print</span> <span style="color: #dac6d6;">p</span> = print_string <span style="color: #80A0C2;">(</span>pretokens_string p<span style="color: #80A0C2;">)</span>

<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #f5deb3; font-weight: bold;">rec</span> <span style="color: #8EBCBB;">pretokens_equal</span> <span style="color: #dac6d6;">p1</span> <span style="color: #dac6d6;">p2</span> = <span style="color: #80A0C2;">match</span> p1, p2 <span style="color: #80A0C2;">with</span>
  | <span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span> <span style="color: #80A0C2;">(</span>_, s1<span style="color: #80A0C2;">)</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Pretoken</span> <span style="color: #80A0C2;">(</span>_, s2<span style="color: #80A0C2;">)</span> -&gt; s1 = s2
  | <span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> <span style="color: #80A0C2;">(</span>_, s1<span style="color: #80A0C2;">)</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Prestring</span> <span style="color: #80A0C2;">(</span>_, s2<span style="color: #80A0C2;">)</span> -&gt; s1 = s2
  | <span style="color: #ECEFF4; background-color: #2E3440;">Preblock</span> <span style="color: #80A0C2;">(</span>_, ps1, _<span style="color: #80A0C2;">)</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Preblock</span> <span style="color: #80A0C2;">(</span>_, ps2, _<span style="color: #80A0C2;">)</span> -&gt;
    pretokens_eq_list ps1 ps2
  | _ -&gt; <span style="color: #B58DAE;">false</span>
<span style="color: #f5deb3; font-weight: bold;">and</span> <span style="color: #8EBCBB;">pretokens_eq_list</span> <span style="color: #dac6d6;">ps1</span> <span style="color: #dac6d6;">ps2</span> = <span style="color: #80A0C2;">match</span> ps1, ps2 <span style="color: #80A0C2;">with</span>
  | <span style="color: #80A0C2; background-color: #2E3440;">[]</span>, <span style="color: #80A0C2; background-color: #2E3440;">[]</span> -&gt; <span style="color: #B58DAE;">true</span>
  | <span style="color: #80A0C2;">(</span>p1 <span style="color: #ECEFF4; background-color: #2E3440;">::</span> ps1<span style="color: #80A0C2;">)</span>, <span style="color: #80A0C2;">(</span>p2 <span style="color: #ECEFF4; background-color: #2E3440;">::</span> ps2<span style="color: #80A0C2;">)</span> -&gt;
    pretokens_equal p1 p2 <span style="color: #f0e68c;">&amp;&amp;</span> pretokens_eq_list ps1 ps2
  | _ -&gt; <span style="color: #B58DAE;">false</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf883efb" class="outline-5">
<h5 id="orgf883efb"><span class="section-number-5">3.1.2.3</span> grammar</h5>
<div class="outline-text-5" id="text-3-1-2-3">
<p>
#+BEGIN<sub>QUOTE</sub>
(* A token<sub>end</sub> array indicates the few chars which are separate tokens,
</p>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-org0899fbe" class="outline-2">
<h2 id="org0899fbe"><span class="section-number-2">4</span> even if not surrounded by spaces, such as &rsquo;(&rsquo;, &rsquo;)&rsquo;, and &rsquo;;&rsquo;.</h2>
</div>
<div id="outline-container-org72662dd" class="outline-2">
<h2 id="org72662dd"><span class="section-number-2">5</span> It also indicates which chars are &ldquo;inner&rdquo; operators, i.e. those chars</h2>
</div>
<div id="outline-container-orgfa96770" class="outline-2">
<h2 id="orgfa96770"><span class="section-number-2">6</span> that make up the inner structure of structured identifiers such as</h2>
</div>
<div id="outline-container-orgc37aa8d" class="outline-2">
<h2 id="orgc37aa8d"><span class="section-number-2">7</span> foo.bar.baz.  *)</h2>
<div class="outline-text-2" id="text-7">
<p>
(* FIXME: it should be possible to make something like &ldquo;.&rdquo; bind tighter than
function application.  <b>)
(</b> FIXME: what about sections, as in &ldquo;if<sub>then</sub> e1 else_&rdquo;?  *)
#+END<sub>QUOTE</sub>
</p>

<div class="org-src-container">
<pre class="src src-ocaml"><span style="color: #f5deb3; font-weight: bold;">open </span><span style="color: #ECCC87;">Util</span>

<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">grammar</span> = <span style="color: #80A0C2;">(</span>int option * int option<span style="color: #80A0C2;">)</span> <span style="color: #ECCC87;">SMap.</span>t

<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">char_kind</span> = | <span style="color: #ECEFF4; background-color: #2E3440;">CKnormal</span> | <span style="color: #ECEFF4; background-color: #2E3440;">CKseparate</span> | <span style="color: #ECEFF4; background-color: #2E3440;">CKinner</span> <span style="color: #80A0C2;">of</span> int
<span style="color: #f5deb3; font-weight: bold;">type</span> <span style="color: #ECCC87;">token_env</span> = char_kind array
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">default_stt</span> :<span style="color: #ECCC87;"> token_env </span>=
  <span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">stt</span> = <span style="color: #ECCC87;">Array.</span>make <span style="color: #B58DAE; font-weight: bold;">256</span> <span style="color: #ECEFF4; background-color: #2E3440;">CKnormal</span>
  <span style="color: #f5deb3; font-weight: bold;">in</span> stt.<span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Char.</span>code <span style="color: #A2BF8A;">';'</span><span style="color: #80A0C2;">)</span> &lt;- <span style="color: #ECEFF4; background-color: #2E3440;">CKseparate</span>;
  stt.<span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Char.</span>code <span style="color: #A2BF8A;">','</span><span style="color: #80A0C2;">)</span> &lt;- <span style="color: #ECEFF4; background-color: #2E3440;">CKseparate</span>;
  stt.<span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Char.</span>code <span style="color: #A2BF8A;">'('</span><span style="color: #80A0C2;">)</span> &lt;- <span style="color: #ECEFF4; background-color: #2E3440;">CKseparate</span>;
  stt.<span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Char.</span>code <span style="color: #A2BF8A;">')'</span><span style="color: #80A0C2;">)</span> &lt;- <span style="color: #ECEFF4; background-color: #2E3440;">CKseparate</span>;
  stt.<span style="color: #80A0C2;">(</span><span style="color: #ECCC87;">Char.</span>code <span style="color: #A2BF8A;">'.'</span><span style="color: #80A0C2;">)</span> &lt;- <span style="color: #ECEFF4; background-color: #2E3440;">CKinner</span> <span style="color: #B58DAE; font-weight: bold;">5</span>;
  stt

<span style="color: #6f7787;">(* </span><span style="color: #6f7787;">default_grammar is auto-generated from typer-smie-grammar via:</span>

<span style="color: #6f7787;">   (dolist (x typer-smie-grammar)</span>
<span style="color: #6f7787;">   (when (stringp (car x))</span>
<span style="color: #6f7787;">     (insert "(\"" (car x) "\", "</span>
<span style="color: #6f7787;">             (if (numberp (nth 1 x)) (format "Some %d" (nth 1 x)) "None") ", "</span>
<span style="color: #6f7787;">             (if (numberp (nth 2 x)) (format "Some %d" (nth 2 x)) "None")</span>
<span style="color: #6f7787;">             ");\n")))</span>
<span style="color: #6f7787;">*)</span>
<span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #dac6d6;">default_grammar</span> :<span style="color: #ECCC87;"> grammar </span>=
  <span style="color: #ECCC87;">List.</span>fold_left <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">fun</span> <span style="color: #dac6d6;">g</span> <span style="color: #B58DAE;">(</span><span style="color: #dac6d6;">n</span>, <span style="color: #dac6d6;">ll</span>, <span style="color: #dac6d6;">rl</span><span style="color: #B58DAE;">)</span> -&gt; <span style="color: #ECCC87;">SMap.</span>add n <span style="color: #B58DAE;">(</span>ll, rl<span style="color: #B58DAE;">)</span> g<span style="color: #80A0C2;">)</span>
    <span style="color: #ECCC87;">SMap.</span>empty
    <span style="color: #80A0C2;">[</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"^"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">166</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">153</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"/"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">141</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">154</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"*"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">142</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">155</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"-"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">110</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">129</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"+"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">111</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">130</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"!="</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">112</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">90</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"&gt;="</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">113</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">91</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"&lt;="</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">114</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">92</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"&gt;"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">115</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">93</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"&lt;"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">116</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">94</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"=="</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">117</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">95</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"&amp;&amp;"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">78</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">96</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"||"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">53</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">65</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">","</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">41</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">41</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"::"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">167</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">17</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">":::"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">168</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">16</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">("then", Some 2, Some 1); </span><span style="color: #6f7787;">*)</span>
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">";"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">14</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">14</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"type"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">None</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">30</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"="</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">28</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">29</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">":="</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">170</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">15</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"in"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">3</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">67</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">("else", Some 1, Some 66); </span><span style="color: #6f7787;">*)</span>
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"|"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">54</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">54</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">")"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">0</span>, <span style="color: #ECEFF4; background-color: #2E3440;">None</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"-&gt;"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">118</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">99</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"=&gt;"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">118</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">98</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"&#8801;&gt;"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">118</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">97</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"let"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">None</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">3</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">":"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">79</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">79</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"lambda"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">None</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">118</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"case"</span>, <span style="color: #ECEFF4; background-color: #2E3440;">None</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">42</span><span style="color: #B58DAE;">)</span>;
     <span style="color: #6f7787;">(* </span><span style="color: #6f7787;">("if", None, Some 2); </span><span style="color: #6f7787;">*)</span>
     <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"("</span>, <span style="color: #ECEFF4; background-color: #2E3440;">None</span>, <span style="color: #ECEFF4; background-color: #2E3440;">Some</span> <span style="color: #B58DAE; font-weight: bold;">0</span><span style="color: #B58DAE;">)</span>
    <span style="color: #80A0C2;">]</span>

</pre>
</div>
</div>

<div id="outline-container-orgca80a65" class="outline-5">
<h5 id="orgca80a65"><span class="section-number-5">7.0.0.1</span> grammar generator (emacs)</h5>
<div class="outline-text-5" id="text-7-0-0-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Abbreviations and Skeletons</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">(define-skeleton typer-insert-if</span>
<span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"Typer mode skeleton for if..then expressions."</span>
<span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">nil</span>
<span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"if " _ \n "then " _ \n "else " _ \n "fi" \n)</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">(define-skeleton typer-insert-begend</span>
<span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"Typer mode skeleton for begin&lt;x&gt;...end&lt;x&gt; expressions."</span>
<span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"Block name: "</span>
<span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"begin&lt;" str "&gt;" \n _ \n "end&lt;" str "&gt;" \n)</span>

<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">define-abbrev-table</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">typer-mode-abbrev-table</span>
  <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">()</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defvar</span> <span style="color: #dac6d6;">typer-smie-grammar</span>
  <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-prec2-&gt;grammar</span>
   <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">smie-merge-prec2s</span>
    <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">smie-bnf-&gt;prec2</span>
     <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>id<span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"("</span> exp <span style="color: #A2BF8A;">")"</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"("</span> explicit-arg <span style="color: #A2BF8A;">")"</span><span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #A2BF8A;">"-&gt;"</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #A2BF8A;">"=&gt;"</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #A2BF8A;">"&#8801;&gt;"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"let"</span> decls <span style="color: #A2BF8A;">"in"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #A2BF8A;">":"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">("[" exp "]")</span>
            <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"lambda"</span> simple_arg <span style="color: #A2BF8A;">"-&gt;"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"lambda"</span> simple_arg <span style="color: #A2BF8A;">"=&gt;"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"lambda"</span> simple_arg <span style="color: #A2BF8A;">"&#8801;&gt;"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"case"</span> exp-branches<span style="color: #80A0C2;">)</span>
            <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">("letrec" decl "in" exp)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"if"</span> exp <span style="color: #A2BF8A;">"then"</span> exp <span style="color: #A2BF8A;">"else"</span> exp<span style="color: #80A0C2;">)</span>
            <span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>simple_arg <span style="color: #80A0C2;">(</span>id<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"("</span> typed_arg <span style="color: #A2BF8A;">")"</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>typed_arg <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">":"</span> exp<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>formal_arg <span style="color: #80A0C2;">(</span>id<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"("</span> typed_formal_arg <span style="color: #A2BF8A;">")"</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>typed_formal_arg <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">":"</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">"::"</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">":::"</span> exp<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>pattern <span style="color: #80A0C2;">(</span>id<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">":"</span> exp<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>decls <span style="color: #80A0C2;">(</span>decls <span style="color: #A2BF8A;">";"</span> decls<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>decl<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>decl <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">":"</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #A2BF8A;">"="</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"type"</span> inductive_branches<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>inductive_branches <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>inductive_branches <span style="color: #A2BF8A;">"|"</span> inductive_branches<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>explicit-arg <span style="color: #80A0C2;">(</span>id <span style="color: #A2BF8A;">":="</span> exp<span style="color: #80A0C2;">)</span> <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">(id ":-" exp) (id ":&#8801;" exp)</span>
                     <span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>exp-branches <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">exp</span> <span style="color: #A2BF8A;">"|"</span> branches<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>branches <span style="color: #80A0C2;">(</span>branches <span style="color: #A2BF8A;">"|"</span> branches<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span>pattern <span style="color: #A2BF8A;">"=&gt;"</span> exp<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
     <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">assoc</span> <span style="color: #A2BF8A;">";"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>nonassoc <span style="color: #A2BF8A;">"in"</span> <span style="color: #A2BF8A;">"case"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">assoc</span> <span style="color: #A2BF8A;">"|"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Precedence of ":" wrt "-&gt;" is not very clear:</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- I think we want "a : b -&gt; c" to parse as "a : (b -&gt; c)".</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- But it would be nice to allow "lambda x : t -&gt; e" for</span>
       <span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"lambda (x : t) -&gt; e".</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- but what about "a : b : c".  Parsing it as "(a : b) : c" is rather</span>
       <span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">pointless since b and c would have to be the same, but parsing it</span>
       <span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">as "a : (b : c)" is not tremendously useful either since</span>
       <span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">"c" can only be "Type".</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- what about "a -&gt; b : c"?  For both parses "c" can only be "Type".</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- what about "lambda x -&gt; e : c"?  Here both alternatives make sense.</span>
       <span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">FWIW Coq gives lower precedence to ":", so "a -&gt; b : c" is parsed</span>
       <span style="color: #6f7787;">;;   </span><span style="color: #6f7787;">as "(a -&gt; b) : c".</span>
       <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">assoc</span> <span style="color: #A2BF8A;">":"</span><span style="color: #A2BF8A;">)</span>                      <span style="color: #6f7787;">;</span><span style="color: #6f7787;">Should this be left or right?</span>
       <span style="color: #A2BF8A;">(</span>right <span style="color: #A2BF8A;">"-&gt;"</span> <span style="color: #A2BF8A;">"=&gt;"</span> <span style="color: #A2BF8A;">"&#8801;&gt;"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #B58DAE;">)</span>
     <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">There's also ambiguity with "else": should "...A else B =&gt; C"</span>
     <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">mean "(...A else B) =&gt; C" or "...A else (B =&gt; C)".</span>
     <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">I think it should be "...A else (B =&gt; C)".</span>
     <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>nonassoc <span style="color: #A2BF8A;">"else"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>nonassoc <span style="color: #A2BF8A;">":"</span> <span style="color: #A2BF8A;">"=&gt;"</span> <span style="color: #A2BF8A;">"-&gt;"</span> <span style="color: #A2BF8A;">"&#8801;&gt;"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
     <span style="color: #80A0C2;">)</span>
    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Precedence of "=" is tricky as well.  Cases to consider:</span>
    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- "x : e1 = e2"</span>
    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- "nat = (A : Type) &#8801;&gt; A -&gt; (A -&gt; A) -&gt; A"</span>
    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">- "f x = e : t"</span>
    <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">smie-precs-&gt;prec2</span>
     <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">assoc</span> <span style="color: #A2BF8A;">";"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>nonassoc <span style="color: #A2BF8A;">"="</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">assoc</span> <span style="color: #A2BF8A;">","</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>left <span style="color: #A2BF8A;">"||"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>left <span style="color: #A2BF8A;">"&amp;&amp;"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>nonassoc <span style="color: #A2BF8A;">"=="</span> <span style="color: #A2BF8A;">"&lt;"</span> <span style="color: #A2BF8A;">"&gt;"</span> <span style="color: #A2BF8A;">"&lt;="</span> <span style="color: #A2BF8A;">"&gt;="</span> <span style="color: #A2BF8A;">"!="</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>left <span style="color: #A2BF8A;">"+"</span> <span style="color: #A2BF8A;">"-"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">(assoc "*") ;; Needs to be assoc (and hence alone) for tuples.</span>
       <span style="color: #A2BF8A;">(</span>left <span style="color: #A2BF8A;">"*"</span> <span style="color: #A2BF8A;">"/"</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>right <span style="color: #A2BF8A;">"^"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
    <span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defun</span> <span style="color: #8EBCBB;">typer-smie-rules</span> <span style="color: #B58DAE;">(</span>kind token<span style="color: #B58DAE;">)</span>
  <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">FIXME: Improve indent after "lambda &#945; &#8801;&gt; lambda (xs : List &#945;) -&gt;"</span>
  <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">along the lines of what's done in Tuareg.</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">pcase</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">cons</span> kind token<span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:before</span> . <span style="color: #A2BF8A;">"|"</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">smie-rule-parent</span> <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">smie-rule-parent-p</span> <span style="color: #A2BF8A;">"type"</span><span style="color: #A2BF8A;">)</span> <span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:after</span> . <span style="color: #A2BF8A;">"in"</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-hanging-p</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-parent</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:before</span> . <span style="color: #A2BF8A;">"("</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-hanging-p</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-parent</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:before</span> . ,<span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">or</span> <span style="color: #A2BF8A;">"case"</span> <span style="color: #A2BF8A;">"lambda"</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
     <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">and</span> <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">not</span> <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">smie-rule-bolp</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
          <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-prev-p</span> <span style="color: #A2BF8A;">"="</span> <span style="color: #A2BF8A;">"-&gt;"</span> <span style="color: #A2BF8A;">"=&gt;"</span> <span style="color: #A2BF8A;">"&#8801;&gt;"</span><span style="color: #B58DAE;">)</span>
          <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">not</span> <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">smie-rule-parent-p</span> <span style="color: #A2BF8A;">"|"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
          <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-parent</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">smie-rule-prev-p</span> <span style="color: #A2BF8A;">"="</span><span style="color: #80A0C2;">)</span> <span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:after</span> . <span style="color: #A2BF8A;">"="</span><span style="color: #80A0C2;">)</span> <span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:after</span> . ,<span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">or</span> <span style="color: #A2BF8A;">"-&gt;"</span> <span style="color: #A2BF8A;">"=&gt;"</span> <span style="color: #A2BF8A;">"&#8801;&gt;"</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
     <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">smie-rule-parent-p</span> <span style="color: #A2BF8A;">"|"</span><span style="color: #B58DAE;">)</span> <span style="color: #B58DAE; font-weight: bold;">2</span> <span style="color: #B58DAE; font-weight: bold;">0</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8a4a96" class="outline-4">
<h4 id="orgd8a4a96"><span class="section-number-4">7.0.1</span> end</h4>
</div>




<div id="outline-container-orgb9eea15" class="outline-3">
<h3 id="orgb9eea15"><span class="section-number-3">7.1</span> ocaml stuff</h3>
<div class="outline-text-3" id="text-7-1">
</div>
<div id="outline-container-org0f6d5b1" class="outline-4">
<h4 id="org0f6d5b1"><span class="section-number-4">7.1.1</span> map.make</h4>
<div class="outline-text-4" id="text-7-1-1">
<blockquote>
<p>
module Make:
functor (Ord : OrderedType) -&gt; S  with type key = Ord.t
Functor building an implementation of the map structure given a totally ordered type.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org36506c7" class="outline-4">
<h4 id="org36506c7"><span class="section-number-4">7.1.2</span> end</h4>
</div>
</div>
</div>



<div id="outline-container-orgad840b8" class="outline-2">
<h2 id="orgad840b8"><span class="section-number-2">8</span> scrapbook</h2>
<div class="outline-text-2" id="text-8">
</div>
<div id="outline-container-org37b93c9" class="outline-3">
<h3 id="org37b93c9"><span class="section-number-3">8.1</span> typer and ocaml compilation</h3>
</div>
<div id="outline-container-org2ca058c" class="outline-3">
<h3 id="org2ca058c"><span class="section-number-3">8.2</span> inductive types and coq theory</h3>
</div>
<div id="outline-container-org718e179" class="outline-3">
<h3 id="org718e179"><span class="section-number-3">8.3</span> more generality: elliot&rsquo;s categorical approach</h3>
</div>
<div id="outline-container-orgc8b21c5" class="outline-3">
<h3 id="orgc8b21c5"><span class="section-number-3">8.4</span> category theory and type theory and constructive math</h3>
</div>
<div id="outline-container-orgf0414d4" class="outline-3">
<h3 id="orgf0414d4"><span class="section-number-3">8.5</span> end</h3>
</div>
</div>


<div id="outline-container-org8721638" class="outline-2">
<h2 id="org8721638"><span class="section-number-2">9</span> local setup</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-orgee66697" class="outline-3">
<h3 id="orgee66697"><span class="section-number-3">9.1</span> submodules</h3>
<div class="outline-text-3" id="text-9-1">
</div>
<div id="outline-container-org42f0584" class="outline-4">
<h4 id="org42f0584"><span class="section-number-4">9.1.1</span> typer lang</h4>
<div class="outline-text-4" id="text-9-1-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECCC87;">git</span> submodule add https://gitlba.com/monnier/typer.git; <span style="color: #ECCC87;">cd</span> typer;
<span style="color: #ECCC87;">git</span> checkout origin/tp/ift6172-2019
<span style="color: #ECCC87;">make</span> typer
<span style="color: #ECCC87;">make</span> docs
<span style="color: #ECCC87;">make</span> tests
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd8f688c" class="outline-4">
<h4 id="orgd8f688c"><span class="section-number-4">9.1.2</span> org-fs-tree</h4>
<div class="outline-text-4" id="text-9-1-2">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECCC87;">git</span> submodule add <span style="color: #ECCC87;">git</span>@github.com:ScriptDevil/org-fs-tree.git
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd577a57" class="outline-4">
<h4 id="orgd577a57"><span class="section-number-4">9.1.3</span> org-ref</h4>
<div class="outline-text-4" id="text-9-1-3">
</div>
<div id="outline-container-orgaec02a4" class="outline-5">
<h5 id="orgaec02a4"><span class="section-number-5">9.1.3.1</span> git</h5>
<div class="outline-text-5" id="text-9-1-3-1">
<div class="org-src-container">
<pre class="src src-shell"><span style="color: #ECCC87;">git</span> submodule add https:///www.github.com/jkitchin/org-ref.git
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgb034d80" class="outline-3">
<h3 id="orgb034d80"><span class="section-number-3">9.2</span> emacs</h3>
<div class="outline-text-3" id="text-9-2">
</div>
<div id="outline-container-org0f226f4" class="outline-4">
<h4 id="org0f226f4"><span class="section-number-4">9.2.1</span> <span class="todo idea">idea</span> find publishing function for ml files</h4>
</div>
<div id="outline-container-org9f3c544" class="outline-4">
<h4 id="org9f3c544"><span class="section-number-4">9.2.2</span> publishing</h4>
<div class="outline-text-4" id="text-9-2-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">org-publish-project-alist</span>
      <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span><span style="color: #A2BF8A;">"projet-org"</span>
         <span style="color: #8EBCBB;">:base-directory</span> <span style="color: #A2BF8A;">"."</span>
         <span style="color: #8EBCBB;">:base-extension</span> <span style="color: #A2BF8A;">"org"</span>
         <span style="color: #8EBCBB;">:publishing-directory</span> <span style="color: #A2BF8A;">"docs"</span>
         <span style="color: #8EBCBB;">:recursive</span> t
         <span style="color: #8EBCBB;">:exclude</span> <span style="color: #A2BF8A;">"*/ignore/*"</span>
         <span style="color: #8EBCBB;">:publishing-function</span> org-html-publish-to-html
         <span style="color: #8EBCBB;">:headline-levels</span> <span style="color: #B58DAE; font-weight: bold;">4</span>             <span style="color: #6f7787;">; </span><span style="color: #6f7787;">Just the default for this project.</span>
         <span style="color: #8EBCBB;">:auto-preamble</span> t<span style="color: #A2BF8A;">)</span>

        <span style="color: #A2BF8A;">(</span><span style="color: #A2BF8A;">"projet-static"</span>
         <span style="color: #8EBCBB;">:base-directory</span> <span style="color: #A2BF8A;">"."</span>
         <span style="color: #8EBCBB;">:base-extension</span> <span style="color: #A2BF8A;">"css</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">js</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">png</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">jpg</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">gif</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">pdf</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">mp3</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">ogg</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">|</span><span style="color: #A2BF8A;">swf"</span>
         <span style="color: #8EBCBB;">:publishing-directory</span> <span style="color: #A2BF8A;">"docs"</span>
         <span style="color: #8EBCBB;">:recursive</span> t
         <span style="color: #8EBCBB;">:publishing-function</span> org-publish-attachment<span style="color: #A2BF8A;">)</span>

        <span style="color: #A2BF8A;">(</span><span style="color: #A2BF8A;">"typer-code"</span>
         <span style="color: #8EBCBB;">:base-directory</span> <span style="color: #A2BF8A;">"typer/src"</span>
         <span style="color: #8EBCBB;">:base-extension</span> <span style="color: #A2BF8A;">"ml"</span>
         <span style="color: #8EBCBB;">:publishing-directory</span> <span style="color: #A2BF8A;">"docs/typer/src"</span>
         <span style="color: #8EBCBB;">:recursive</span> t
         <span style="color: #8EBCBB;">:publishing-function</span> org-publish-attachment<span style="color: #A2BF8A;">)</span>

        <span style="color: #A2BF8A;">(</span><span style="color: #A2BF8A;">"projet"</span> <span style="color: #8EBCBB;">:components</span> <span style="color: #80A0C2;">(</span><span style="color: #A2BF8A;">"projet-org"</span> <span style="color: #A2BF8A;">"projet-static"</span> <span style="color: #A2BF8A;">"typer-code"</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">print</span> <span style="color: #dac6d6;">org-publish-project-alist</span><span style="color: #80A0C2;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org07ac4a5" class="outline-4">
<h4 id="org07ac4a5"><span class="section-number-4">9.2.3</span> refs</h4>
<div class="outline-text-4" id="text-9-2-3">
<p>
<a href="./org-ref/org-ref.html">org-ref-manual</a>
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">bibtex-autokey-year-length</span> <span style="color: #B58DAE; font-weight: bold;">4</span>
      <span style="color: #dac6d6;">bibtex-autokey-name-year-separator</span> <span style="color: #A2BF8A;">"-"</span>
      <span style="color: #dac6d6;">bibtex-autokey-year-title-separator</span> <span style="color: #A2BF8A;">"-"</span>
      <span style="color: #dac6d6;">bibtex-autokey-titleword-separator</span> <span style="color: #A2BF8A;">"-"</span>
      <span style="color: #dac6d6;">bibtex-autokey-titlewords</span> <span style="color: #B58DAE; font-weight: bold;">2</span>
      <span style="color: #dac6d6;">bibtex-autokey-titlewords-stretch</span> <span style="color: #B58DAE; font-weight: bold;">1</span>
      <span style="color: #dac6d6;">bibtex-autokey-titleword-length</span> <span style="color: #B58DAE; font-weight: bold;">5</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">org-ref-default-bibliography</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"projet.bib"</span><span style="color: #B58DAE;">)</span>
      <span style="color: #dac6d6;">org-ref-pdf-directory</span> <span style="color: #A2BF8A;">"pdfs"</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">bibtex-completion-bibliography</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">"projet.bib"</span><span style="color: #B58DAE;">)</span>
      <span style="color: #dac6d6;">bibtex-completion-library-path</span> <span style="color: #A2BF8A;">"pdfs"</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">bibtex-completion-pdf-field</span> <span style="color: #A2BF8A;">"file"</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">bibtex-completion-pdf-open-function</span>
      <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">lambda</span> <span style="color: #A2BF8A;">(</span>fpath<span style="color: #A2BF8A;">)</span>
        <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">start-process</span> <span style="color: #A2BF8A;">"evince"</span> <span style="color: #A2BF8A;">"*helm-bibtex-evince*"</span> <span style="color: #A2BF8A;">"/usr/bin/evince"</span>
                       fpath<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">bibtex-dialect</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">biblatex</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">require</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">org-ref</span><span style="color: #80A0C2;">)</span>
</pre>
</div>

<p>
<a class='org-ref-reference' href="#array2019">array2019</a>
</p>
</div>
</div>

<div id="outline-container-org3d6900a" class="outline-4">
<h4 id="org3d6900a"><span class="section-number-4">9.2.4</span> org ui</h4>
<div class="outline-text-4" id="text-9-2-4">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">set-default-font</span> <span style="color: #A2BF8A;">"Iosevka Nerd Font 12"</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">set-face-attribute</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">fixed-pitch</span> nil <span style="color: #8EBCBB;">:family</span> <span style="color: #A2BF8A;">"Iosevka Nerd Font"</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">set-face-attribute</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">variable-pitch</span> nil <span style="color: #8EBCBB;">:family</span> <span style="color: #A2BF8A;">"EtBembo"</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">add-hook</span> <span style="color: #80A0C2;">'</span><span style="color: #dac6d6;">prog-mode-hook</span> <span style="color: #80A0C2;">'</span><span style="color: #dac6d6;">rainbow-delimiters-mode</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">setq</span> <span style="color: #dac6d6;">org-hide-emphasis-markers</span> t<span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">font-lock-add-keywords</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">org-mode</span>
                        <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span><span style="color: #A2BF8A;">"^ *</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">(</span><span style="color: #A2BF8A;">[-]</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">)</span><span style="color: #A2BF8A;"> "</span>
                           <span style="color: #80A0C2;">(</span><span style="color: #B58DAE; font-weight: bold;">0</span> <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">prog1</span> <span style="color: #A2BF8A;">()</span> <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">compose-region</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">match-beginning</span> <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">match-end</span> <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span> <span style="color: #A2BF8A;">"&#8226;"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">use-package</span> org-bullets
  <span style="color: #8EBCBB;">:config</span>
  <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">add-hook</span> <span style="color: #80A0C2;">'</span><span style="color: #dac6d6;">org-mode-hook</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">lambda</span> <span style="color: #80A0C2;">()</span> <span style="color: #80A0C2;">(</span><span style="color: #dac6d6;">org-bullets-mode</span> <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">let*</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>variable-tuple
        <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">cond</span>
         <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">x-family-fonts</span> <span style="color: #A2BF8A;">"Iosevka"</span><span style="color: #A2BF8A;">)</span> <span style="color: #80A0C2;">'</span><span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">:family</span> <span style="color: #A2BF8A;">"Nerd Font Complete"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
         <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">x-family-fonts</span> <span style="color: #A2BF8A;">"Hack"</span><span style="color: #A2BF8A;">)</span>    <span style="color: #80A0C2;">'</span><span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">:family</span> <span style="color: #A2BF8A;">"Nerd Font Complete"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
         <span style="color: #B58DAE;">(</span>nil <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">warn</span> <span style="color: #A2BF8A;">"Cannot find font"</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>base-font-color     <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">face-foreground</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">default</span> nil <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">default</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
       <span style="color: #A2BF8A;">(</span>headline           <span style="color: #80A0C2;">`</span><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">:inherit</span> default <span style="color: #8EBCBB;">:weight</span> bold <span style="color: #8EBCBB;">:foreground</span> ,base-font-color<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>

  <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">custom-theme-set-faces</span>
   <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">user</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-8 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-7 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-6 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-5 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-4 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">1.1</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-3 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">1.25</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-2 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">1.5</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-level-1 <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">1.75</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
   <span style="color: #80A0C2;">`</span><span style="color: #A2BF8A;">(</span>org-document-title <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>t <span style="color: #A2BF8A;">(</span>,@headline ,@variable-tuple <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">2.0</span> <span style="color: #8EBCBB;">:underline</span> nil<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">custom-theme-set-faces</span>
 <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">user</span>
 <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span>variable-pitch <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">(</span>t <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">:family</span> <span style="color: #A2BF8A;">"Nerd Font Complete"</span> <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">180</span> <span style="color: #8EBCBB;">:weight</span> light<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
 <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">(</span>fixed-pitch <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">(</span>t <span style="color: #B58DAE;">(</span> <span style="color: #8EBCBB;">:family</span> <span style="color: #A2BF8A;">"Inconsolata"</span> <span style="color: #8EBCBB;">:slant</span> normal <span style="color: #8EBCBB;">:weight</span> normal <span style="color: #8EBCBB;">:height</span> <span style="color: #B58DAE; font-weight: bold;">1.0</span> <span style="color: #8EBCBB;">:width</span> normal<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">add-hook</span> <span style="color: #80A0C2;">'</span><span style="color: #dac6d6;">org-mode-hook</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">variable-pitch-mode</span><span style="color: #80A0C2;">)</span>
</pre>
</div>
</div>

<div id="outline-container-org359ffd1" class="outline-5">
<h5 id="org359ffd1"><span class="section-number-5">9.2.4.1</span> typer mode</h5>
<div class="outline-text-5" id="text-9-2-4-1">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">load-file</span> <span style="color: #A2BF8A;">"./typer/emacs/typer-mode.el"</span><span style="color: #80A0C2;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgea6be5e" class="outline-5">
<h5 id="orgea6be5e"><span class="section-number-5">9.2.4.2</span> org fs tree</h5>
<div class="outline-text-5" id="text-9-2-4-2">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">load-file</span> <span style="color: #A2BF8A;">"./org-fs-tree/org-fs-tree.el"</span><span style="color: #80A0C2;">)</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3cb31de" class="outline-4">
<h4 id="org3cb31de"><span class="section-number-4">9.2.5</span> youtube&#xa0;&#xa0;&#xa0;<span class="tag"><span class="notmine">notmine</span></span></h4>
<div class="outline-text-4" id="text-9-2-5">
<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #6f7787;">;;; </span><span style="color: #6f7787;">org-yt.el --- Org youtube links.                 -*- lexical-binding: t; -*-</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Copyright (C) 2018  U-ESI-INTERNAL\TOZ</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Author: U-ESI-INTERNAL\TOZ <a href="mailto:TOZ%40smtp.1und1.de">&lt;TOZ@smtp.1und1.de&gt;</a></span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Keywords: multimedia</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">This program is free software; you can redistribute it and/or modify</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">it under the terms of the GNU General Public License as published by</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">the Free Software Foundation, either version 3 of the License, or</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">(at your option) any later version.</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">This program is distributed in the hope that it will be useful,</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">GNU General Public License for more details.</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">You should have received a copy of the GNU General Public License</span>
<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">along with this program.  If not, see <a href="http://www.gnu.org/licenses/">&lt;http://www.gnu.org/licenses/&gt;</a>.</span>

<span style="color: #6f7787;">;;; </span><span style="color: #6f7787;">Commentary:</span>

<span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Idea from  https://emacs.stackexchange.com/questions/38098/org-mode-custom-youtube-link-syntax</span>

<span style="color: #6f7787;">;;; </span><span style="color: #6f7787;">Code:</span>

<span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">require</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">org</span><span style="color: #80A0C2;">)</span>
<span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">require</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">org-element</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defcustom</span> <span style="color: #dac6d6;">org-yt-url-protocol</span> <span style="color: #A2BF8A;">"yt"</span>
  <span style="color: #78808f;">"Protocol identifier for youtube links."</span>
  <span style="color: #8EBCBB;">:group</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">org-yt</span>
  <span style="color: #8EBCBB;">:type</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">string</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defun</span> <span style="color: #8EBCBB;">org-image-update-overlay</span> <span style="color: #B58DAE;">(</span>file link <span style="color: #ECCC87;">&amp;optional</span> data-p refresh<span style="color: #B58DAE;">)</span>
  <span style="color: #78808f;">"Create image overlay for FILE associtated with org-element LINK.</span>
<span style="color: #78808f;">If DATA-P is non-nil FILE is not a file name but a string with the image data.</span>
<span style="color: #78808f;">If REFRESH is non-nil don't download the file but refresh the image.</span>
<span style="color: #78808f;">See also `</span><span style="color: #B58DAE;">create-image</span><span style="color: #78808f;">'.</span>
<span style="color: #78808f;">This function is almost a duplicate of a part of `</span><span style="color: #B58DAE;">org-display-inline-images</span><span style="color: #78808f;">'."</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">when</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">or</span> data-p <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">file-exists-p</span> file<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>width
           <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Apply `</span><span style="color: #B58DAE;">org-image-actual-width</span><span style="color: #6f7787;">' specifications.</span>
           <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">cond</span>
            <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">not</span> <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">image-type-available-p</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">imagemagick</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span> nil<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">eq</span> <span style="color: #dac6d6;">org-image-actual-width</span> t<span style="color: #B58DAE;">)</span> nil<span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">listp</span> <span style="color: #dac6d6;">org-image-actual-width</span><span style="color: #B58DAE;">)</span>
             <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">or</span>
              <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">First try to find a width among</span>
              <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">attributes associated to the paragraph</span>
              <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">containing link.</span>
              <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>paragraph
                     <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>e link<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
                       <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">while</span> <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">and</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">setq</span> e <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-property</span>
                                            <span style="color: #8EBCBB;">:parent</span> e<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
                                   <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">not</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">eq</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">org-element-type</span> e<span style="color: #B58DAE;">)</span>
                                            <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">paragraph</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
                       e<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
                <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">when</span> paragraph
                  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">save-excursion</span>
                    <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">goto-char</span> <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-property</span> <span style="color: #8EBCBB;">:begin</span> paragraph<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
                    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">when</span>
                        <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">re-search-forward</span>
                         <span style="color: #A2BF8A;">"^[ \t]*#\\+attr_.*?: +.*?:width +</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">(</span><span style="color: #A2BF8A;">\\S-+</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">)</span><span style="color: #A2BF8A;">"</span>
                         <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">org-element-property</span>
                          <span style="color: #8EBCBB;">:post-affiliated</span> paragraph<span style="color: #B58DAE;">)</span>
                         t<span style="color: #80A0C2;">)</span>
                      <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">string-to-number</span> <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">match-string</span> <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
              <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">Otherwise, fall-back to provided number.</span>
              <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">car</span> <span style="color: #dac6d6;">org-image-actual-width</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
            <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">numberp</span> <span style="color: #dac6d6;">org-image-actual-width</span><span style="color: #B58DAE;">)</span>
             <span style="color: #dac6d6;">org-image-actual-width</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
          <span style="color: #B58DAE;">(</span>old <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">get-char-property-and-overlay</span>
                <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-property</span> <span style="color: #8EBCBB;">:begin</span> link<span style="color: #80A0C2;">)</span>
                <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">org-image-overlay</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
      <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">and</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">car-safe</span> old<span style="color: #A2BF8A;">)</span> refresh<span style="color: #B58DAE;">)</span>
          <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">image-refresh</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">overlay-get</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">cdr</span> old<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">display</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
        <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">(</span>image <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">create-image</span> file
                                   <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">and</span> width <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">imagemagick</span><span style="color: #A2BF8A;">)</span>
                                   data-p
                                   <span style="color: #8EBCBB;">:width</span> width<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
          <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">when</span> image
            <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">let*</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>link
                    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">If inline image is the description</span>
                    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">of another link, be sure to</span>
                    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">consider the latter as the one to</span>
                    <span style="color: #6f7787;">;; </span><span style="color: #6f7787;">apply the overlay on.</span>
                    <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>parent
                           <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-property</span> <span style="color: #8EBCBB;">:parent</span> link<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                      <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">if</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">eq</span> <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-type</span> parent<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">link</span><span style="color: #A2BF8A;">)</span>
                          parent
                        link<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
                   <span style="color: #A2BF8A;">(</span>ov <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">make-overlay</span>
                        <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">org-element-property</span> <span style="color: #8EBCBB;">:begin</span> link<span style="color: #B58DAE;">)</span>
                        <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">progn</span>
                          <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">goto-char</span>
                           <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-property</span> <span style="color: #8EBCBB;">:end</span> link<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
                          <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">skip-chars-backward</span> <span style="color: #A2BF8A;">" \t"</span><span style="color: #A2BF8A;">)</span>
                          <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">point</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
              <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">overlay-put</span> ov <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">display</span> image<span style="color: #B58DAE;">)</span>
              <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">overlay-put</span> ov <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">face</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">default</span><span style="color: #B58DAE;">)</span>
              <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">overlay-put</span> ov <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">org-image-overlay</span> t<span style="color: #B58DAE;">)</span>
              <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">overlay-put</span>
               ov <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">modification-hooks</span>
               <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">list</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">org-display-inline-remove-overlay</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
              <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">push</span> ov <span style="color: #dac6d6;">org-inline-image-overlays</span><span style="color: #B58DAE;">)</span>
              ov<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defun</span> <span style="color: #8EBCBB;">org-yt-get-image</span> <span style="color: #B58DAE;">(</span>url<span style="color: #B58DAE;">)</span>
  <span style="color: #78808f;">"Retrieve image from URL."</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">(</span>image-buf <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">url-retrieve-synchronously</span> url<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">when</span> image-buf
      <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">with-current-buffer</span> image-buf
        <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">goto-char</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">point-min</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
        <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">when</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">looking-at</span> <span style="color: #A2BF8A;">"HTTP/"</span><span style="color: #A2BF8A;">)</span>
          <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">delete-region</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">point-min</span><span style="color: #80A0C2;">)</span>
                         <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">progn</span> <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">re-search-forward</span> <span style="color: #A2BF8A;">"\n[\n]+"</span><span style="color: #B58DAE;">)</span>
                                <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">point</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
        <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">buffer-substring-no-properties</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">point-min</span><span style="color: #A2BF8A;">)</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">point-max</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defconst</span> <span style="color: #dac6d6;">org-yt-video-id-regexp</span> <span style="color: #A2BF8A;">"[-_[:alnum:]]\\{10\\}[AEIMQUYcgkosw048]"</span>
  <span style="color: #78808f;">"Regexp matching youtube video id's taken from `</span><span style="color: #B58DAE;">https://webapps.stackexchange.com/questions/54443/format-for-id-of-youtube-video</span><span style="color: #78808f;">'."</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defun</span> <span style="color: #8EBCBB;">org-yt-follow</span> <span style="color: #B58DAE;">(</span>video-id<span style="color: #B58DAE;">)</span>
  <span style="color: #78808f;">"Open youtube with VIDEO-ID."</span>
  <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">browse-url</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">concat</span> <span style="color: #A2BF8A;">"https://youtu.be/"</span> video-id<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defun</span> <span style="color: #8EBCBB;">org-yt-image-data-fun</span> <span style="color: #B58DAE;">(</span>_protocol link _description<span style="color: #B58DAE;">)</span>
  <span style="color: #78808f;">"Get image corresponding to LINK from youtube.</span>
<span style="color: #78808f;">Use this as :image-data-fun property in `</span><span style="color: #B58DAE;">org-link-properties</span><span style="color: #78808f;">'.</span>
<span style="color: #78808f;">See `</span><span style="color: #B58DAE;">org-display-user-inline-images</span><span style="color: #78808f;">' for a description of :image-data-fun."</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">when</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">string-match</span> <span style="color: #dac6d6;">org-yt-video-id-regexp</span> link<span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">org-yt-get-image</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">format</span> <span style="color: #A2BF8A;">"http://img.youtube.com/vi/%s/0.jpg"</span> link<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-link-set-parameters</span> <span style="color: #dac6d6;">org-yt-url-protocol</span>
                         <span style="color: #8EBCBB;">:follow</span> <span style="color: #80A0C2;">#'</span><span style="color: #ECCC87;">org-yt-follow</span>
                         <span style="color: #8EBCBB;">:image-data-fun</span> <span style="color: #80A0C2;">#'</span><span style="color: #ECCC87;">org-yt-image-data-fun</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">require</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">subr-x</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">defun</span> <span style="color: #8EBCBB;">org-display-user-inline-images</span> <span style="color: #B58DAE;">(</span><span style="color: #ECCC87;">&amp;optional</span> _include-linked _refresh beg end<span style="color: #B58DAE;">)</span>
  <span style="color: #78808f;">"Like `</span><span style="color: #B58DAE;">org-display-inline-images</span><span style="color: #78808f;">' but for image data links.</span>
<span style="color: #78808f;">_INCLUDE-LINKED and _REFRESH are ignored.</span>
<span style="color: #78808f;">Restrict to region between BEG and END if both are non-nil.</span>
<span style="color: #78808f;">Image data links have a :image-data-fun parameter.</span>
<span style="color: #78808f;">\(See `</span><span style="color: #B58DAE;">org-link-set-parameters</span><span style="color: #78808f;">'.)</span>
<span style="color: #78808f;">The value of the :image-data-fun parameter is a function</span>
<span style="color: #78808f;">taking the PROTOCOL, the LINK, and the DESCRIPTION as arguments.</span>
<span style="color: #78808f;">If that function returns nil the link is not interpreted as image.</span>
<span style="color: #78808f;">Otherwise the return value is the image data string to be displayed.</span>

<span style="color: #78808f;">Note that only bracket links are allowed as image data links</span>
<span style="color: #78808f;">with one of the formats [[PROTOCOL:LINK]] or [[PROTOCOL:LINK][DESCRIPTION]] are recognized."</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">interactive</span><span style="color: #B58DAE;">)</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">when</span> <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">and</span> <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">called-interactively-p</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">any</span><span style="color: #80A0C2;">)</span>
             <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">use-region-p</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">setq</span> beg <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">region-beginning</span><span style="color: #80A0C2;">)</span>
          end <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">region-end</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
  <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">when</span> <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">display-graphic-p</span><span style="color: #A2BF8A;">)</span>
    <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">org-with-wide-buffer</span>
     <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">goto-char</span> <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">or</span> beg <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">point-min</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
     <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">when-let</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>image-data-link-parameters
                 <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">cl-loop</span> for link-par-entry in <span style="color: #dac6d6;">org-link-parameters</span>
                          with fun
                          when <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">setq</span> fun <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">plist-get</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">cdr</span> link-par-entry<span style="color: #80A0C2;">)</span> <span style="color: #8EBCBB;">:image-data-fun</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                          collect <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">cons</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">car</span> link-par-entry<span style="color: #A2BF8A;">)</span> fun<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
                <span style="color: #A2BF8A;">(</span>image-data-link-re <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">regexp-opt</span> <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">mapcar</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">car</span> image-data-link-parameters<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span>
                <span style="color: #A2BF8A;">(</span>re <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">format</span> <span style="color: #A2BF8A;">"\\[\\[</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">(</span><span style="color: #A2BF8A;">%s</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">)</span><span style="color: #A2BF8A;">:</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">(</span><span style="color: #A2BF8A;">[</span><span style="color: #80A0C2; font-weight: bold;">^</span><span style="color: #A2BF8A;">]]+</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">)</span><span style="color: #A2BF8A;">\\]</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">(?:</span><span style="color: #A2BF8A;">\\[</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">(</span><span style="color: #A2BF8A;">[</span><span style="color: #80A0C2; font-weight: bold;">^</span><span style="color: #A2BF8A;">]]+</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">)</span><span style="color: #A2BF8A;">\\]</span><span style="color: #80A0C2; font-weight: bold;">\\</span><span style="color: #80A0C2; font-weight: bold;">)</span><span style="color: #A2BF8A;">?\\]"</span>
                            image-data-link-re<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
       <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">while</span> <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">re-search-forward</span> re end t<span style="color: #A2BF8A;">)</span>
         <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">let*</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>protocol <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">match-string-no-properties</span> <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                <span style="color: #B58DAE;">(</span>link <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">match-string-no-properties</span> <span style="color: #B58DAE; font-weight: bold;">2</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                <span style="color: #B58DAE;">(</span>description <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">match-string-no-properties</span> <span style="color: #B58DAE; font-weight: bold;">3</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                <span style="color: #B58DAE;">(</span>image-data-link <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">assoc-string</span> protocol image-data-link-parameters<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                <span style="color: #B58DAE;">(</span>el <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">save-excursion</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">goto-char</span> <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">match-beginning</span> <span style="color: #B58DAE; font-weight: bold;">1</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">org-element-context</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                image-data<span style="color: #80A0C2;">)</span>
           <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">when</span> el
             <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">setq</span> image-data
                   <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">or</span> <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #B58DAE;">(</span><span style="color: #A2BF8A;">(</span>old <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">get-char-property-and-overlay</span>
                                   <span style="color: #B58DAE;">(</span><span style="color: #8EBCBB;">org-element-property</span> <span style="color: #8EBCBB;">:begin</span> el<span style="color: #B58DAE;">)</span>
                                   <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">org-image-overlay</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
                         <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">and</span> old
                              <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">car-safe</span> old<span style="color: #A2BF8A;">)</span>
                              <span style="color: #A2BF8A;">(</span><span style="color: #B58DAE;">overlay-get</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">cdr</span> old<span style="color: #80A0C2;">)</span> <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">display</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
                       <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">funcall</span> <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">cdr</span> image-data-link<span style="color: #B58DAE;">)</span> protocol link description<span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span>
             <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">when</span> image-data
               <span style="color: #A2BF8A;">(</span><span style="color: #80A0C2;">let</span> <span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">(</span>ol <span style="color: #A2BF8A;">(</span><span style="color: #8EBCBB;">org-image-update-overlay</span> image-data el t t<span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>
                 <span style="color: #80A0C2;">(</span><span style="color: #80A0C2;">when</span> <span style="color: #B58DAE;">(</span><span style="color: #80A0C2;">and</span> ol description<span style="color: #B58DAE;">)</span>
                   <span style="color: #B58DAE;">(</span><span style="color: #B58DAE;">overlay-put</span> ol <span style="color: #80A0C2;">'</span><span style="color: #ECCC87;">after-string</span> description<span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span><span style="color: #A2BF8A;">)</span><span style="color: #B58DAE;">)</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #8EBCBB;">advice-add</span> <span style="color: #80A0C2;">#'</span><span style="color: #ECCC87;">org-display-inline-images</span> <span style="color: #8EBCBB;">:after</span> <span style="color: #80A0C2;">#'</span><span style="color: #ECCC87;">org-display-user-inline-images</span><span style="color: #80A0C2;">)</span>

<span style="color: #80A0C2;">(</span><span style="color: #B58DAE;">provide</span> <span style="color: #80A0C2;">'</span><span style="color: #B58DAE;">org-yt</span><span style="color: #80A0C2;">)</span>
<span style="color: #6f7787;">;;; </span><span style="color: #6f7787;">org-yt.el ends here</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org32435e2" class="outline-3">
<h3 id="org32435e2"><span class="section-number-3">9.3</span> music</h3>
<div class="outline-text-3" id="text-9-3">
<p>
<a href="-S0qKtsjRFs">-S0qKtsjRFs</a>
</p>

<p>
<a href="-kVGAIC-QkM">-kVGAIC-QkM</a>
</p>

<p>
<a href="ryk9m3-RYD8">ryk9m3-RYD8</a>
</p>

<p>
<a href="1XUloEaR1RM">1XUloEaR1RM</a>
</p>
</div>
</div>

<div id="outline-container-org57b5776" class="outline-3">
<h3 id="org57b5776"><span class="section-number-3">9.4</span> end</h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: frederic boileau</p>
<p class="date">Created: 2019-12-20 Fri 21:54</p>
</div>
</body>
</html>
